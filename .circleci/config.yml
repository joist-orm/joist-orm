version: 2.1
workflows:
  version: 2
  workflow:
    jobs:
      - build
      - release:
          requires:
            - build
          filters:
            branches:
              only:
                - main

jobs:
  build:
    machine:
      image: ubuntu-2004:202104-01
    steps:
      - checkout
      - run: |
          cd packages/integration-tests
          docker-compose build db tests
          docker-compose up db-wait
          docker-compose up -d tests
      - run: |
          cd packages/integration-tests
          docker-compose exec tests ./tests.sh
  release:
    machine:
      image: ubuntu-2004:202104-01
    steps:
      - checkout
      - run:
          name: release
          command: |
            cd packages/integration-tests
            docker-compose exec tests ./release.sh
