"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1238],{7716:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>o,toc:()=>c});var s=i(2540),r=i(3023);const t={title:"Recursive Relations",sidebar_position:4},a=void 0,o={id:"advanced/recursive-relations",title:"Recursive Relations",description:"Overview",source:"@site/docs/advanced/recursive-relations.md",sourceDirName:"advanced",slug:"/advanced/recursive-relations",permalink:"/docs/advanced/recursive-relations",draft:!1,unlisted:!1,editUrl:"https://github.com/joist-orm/joist-orm/edit/main/docs/docs/advanced/recursive-relations.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"Recursive Relations",sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Large Collections",permalink:"/docs/advanced/large-collections"},next:{title:"Json Payloads",permalink:"/docs/advanced/json-payloads"}},l={},c=[{value:"Overview",id:"overview",level:3},{value:"Recursive Relations",id:"recursive-relations",level:3},{value:"Consistent View",id:"consistent-view",level:3},{value:"Cycle Detection",id:"cycle-detection",level:3},{value:"Disabling Recursive Relations",id:"disabling-recursive-relations",level:3}];function d(e){const n={a:"a",code:"code",h3:"h3",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h3,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"A common pattern in domain modeling is nested parent/child relationships, i.e. a parent that has multiple children, which themselves can have multiple grand children."}),"\n",(0,s.jsxs)(n.p,{children:["For example an ",(0,s.jsx)(n.code,{children:"employees.manager_id"})," FK that generates normal many-to-one and one-to-many relations:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"class Employee {\n  manager: Reference<Employee, Employee>;\n  reports: Collection<Employee, Employee[]>;\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:'These relations fetch "the immediate manager" and "the immediate reports", but often you want to fetch "the whole tree", i.e. a manager and all of their reports recursively.'}),"\n",(0,s.jsxs)(n.p,{children:["This has historically been difficult in relational databases (requiring approaches like ",(0,s.jsx)(n.code,{children:"lpath"})," and closure tables, see ",(0,s.jsx)(n.a,{href:"https://www.ackee.agency/blog/hierarchical-models-in-postgresql",children:"this blog post"}),"), but now can be done in Postgres using recursive CTEs."]}),"\n",(0,s.jsx)(n.h3,{id:"recursive-relations",children:"Recursive Relations"}),"\n",(0,s.jsxs)(n.p,{children:['Whenever Joist sees a foreign key that is self-referential, Joist will automatically create recursive relations, in addition to the "immediate" o2m and m2o, i.e. for a ',(0,s.jsx)(n.code,{children:"employees.manager_id"})," FK, you'll get:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"class Employee {\n  // immediate relations\n  manager: Reference<Employee, Employee>;\n  reports: Collection<Employee, Employee[]>;\n  // recursive relations\n  managersRecursive: Reference<Employee, Employee>;\n  reportsRecursive: Collection<Employee, Employee[]>;\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"And if you call:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"await m1.reportsRecursive.load();\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Joist will issue a single SQL call to fetch all ",(0,s.jsx)(n.code,{children:"m1"}),"'s reports, and all their reports, etc. in a single query."]}),"\n",(0,s.jsx)(n.p,{children:"This method is also automatically batched, so if you invoke it in a loop, or a validation rule, or other business logic, for multiple managers at once, it will still create a single SQL call."}),"\n",(0,s.jsx)(n.h3,{id:"consistent-view",children:"Consistent View"}),"\n",(0,s.jsx)(n.p,{children:'As with other Joist relations, the recursive relations provide a "consistent view" of the entity graph.'}),"\n",(0,s.jsxs)(n.p,{children:["For example, if you've modified the employee/manager relationship for any employees in the current ",(0,s.jsx)(n.code,{children:"EntityManager"})," unit of work, and then later call either ",(0,s.jsx)(n.code,{children:"managersRecursive"})," or ",(0,s.jsx)(n.code,{children:"reportsRecursive"}),", we will load the recursive data from the database (if not already loaded), and also apply any WIP, uncommitted changes to the hierarchy."]}),"\n",(0,s.jsx)(n.p,{children:"This ensures your code can rely on the recursive relations to be up-to-date, and should dramatically simplify reasoning about/enforcing rules while persisting changes."}),"\n",(0,s.jsx)(n.h3,{id:"cycle-detection",children:"Cycle Detection"}),"\n",(0,s.jsx)(n.p,{children:"Joist's recursive relations currently always reject cycles."}),"\n",(0,s.jsx)(n.p,{children:'Note that we do not automatically add an "enforce no cycles" validation rule to recursive relations by default, but if you do access any relation (either recursive parents or recursive children) that does have a cycle, we\'ll throw an error.'}),"\n",(0,s.jsx)(n.p,{children:"Given this, it's advised to add your own cycle-preventing validation rules."}),"\n",(0,s.jsx)(n.p,{children:"This behavior should likely be configurable (i.e. to allow cycles), but has not been implemented yet."}),"\n",(0,s.jsx)(n.h3,{id:"disabling-recursive-relations",children:"Disabling Recursive Relations"}),"\n",(0,s.jsxs)(n.p,{children:["If you don't want/need the recursive relations, you can disable them by setting ",(0,s.jsx)(n.code,{children:"skipRecursiveRelations: true"})," in ",(0,s.jsx)(n.code,{children:"joist-config.json"})," for the self-referencing m2o relation, i.e.:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "entities": {\n    "User": {\n      "tag": "u",\n      "relations": {\n        "manager": {\n          "skipRecursiveRelations": true\n        }\n      }\n    }\n  }\n}\n'})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},3023:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>o});var s=i(3696);const r={},t=s.createContext(r);function a(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);