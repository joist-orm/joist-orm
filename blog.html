<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Blog | Joist</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://joist-orm.io/blog"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="keywords" content="TypeScript, ORM, Reactivity, Domain Driven Design, Unit of Work, ActiveRecord"><meta data-rh="true" property="og:title" content="Blog | Joist"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="canonical" href="https://joist-orm.io/blog"><link data-rh="true" rel="alternate" href="https://joist-orm.io/blog" hreflang="en"><link data-rh="true" rel="alternate" href="https://joist-orm.io/blog" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Blog","@id":"https://joist-orm.io/blog","mainEntityOfPage":"https://joist-orm.io/blog","headline":"Blog","description":"Blog","blogPost":[{"@type":"BlogPosting","@id":"https://joist-orm.io/blog/recursive-relations","mainEntityOfPage":"https://joist-orm.io/blog/recursive-relations","url":"https://joist-orm.io/blog/recursive-relations","headline":"Recursive Relations","name":"Recursive Relations","description":"Joist's development is currently very incremental, and doesn't have \"big release\" milestones & release notes, but we recently released a notable new featuretada:","datePublished":"2024-07-20T00:00:00.000Z","author":{"@type":"Person","name":"Stephen Haberman","url":"https://github.com/stephenh","image":"https://github.com/stephenh.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://joist-orm.io/blog/the-best-orm-ever","mainEntityOfPage":"https://joist-orm.io/blog/the-best-orm-ever","url":"https://joist-orm.io/blog/the-best-orm-ever","headline":"Is Joist the Best ORM, Ever?","name":"Is Joist the Best ORM, Ever?","description":"A thought experiment on whether Joist is the best ORM ever.","datePublished":"2024-05-11T00:00:00.000Z","author":{"@type":"Person","name":"Stephen Haberman","url":"https://github.com/stephenh","image":"https://github.com/stephenh.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://joist-orm.io/blog/nextjs-sample-app","mainEntityOfPage":"https://joist-orm.io/blog/nextjs-sample-app","url":"https://joist-orm.io/blog/nextjs-sample-app","headline":"New NextJS Sample App","name":"New NextJS Sample App","description":"We've added a new NextJS sample app to the Joist repository.","datePublished":"2024-04-21T00:00:00.000Z","author":{"@type":"Person","name":"Stephen Haberman","url":"https://github.com/stephenh","image":"https://github.com/stephenh.png"},"keywords":[]},{"@type":"BlogPosting","@id":"https://joist-orm.io/blog/welcome-blog","mainEntityOfPage":"https://joist-orm.io/blog/welcome-blog","url":"https://joist-orm.io/blog/welcome-blog","headline":"Welcome","name":"Welcome","description":"First post on the Joist blog.","datePublished":"2024-04-13T00:00:00.000Z","author":{"@type":"Person","name":"Stephen Haberman","url":"https://github.com/stephenh","image":"https://github.com/stephenh.png"},"keywords":[]}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Joist RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Joist Atom Feed"><link rel="stylesheet" href="/assets/css/styles.360bd5de.css">
<script src="/assets/js/runtime~main.39dff0dd.js" defer="defer"></script>
<script src="/assets/js/main.4c0a7391.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_oPtH" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Joist</b></a><a class="navbar__item navbar__link" href="/docs/getting-started">Getting Started</a><a class="navbar__item navbar__link" href="/docs/goals">Goals</a><a class="navbar__item navbar__link" href="/docs/modeling/fields">Domain Modeling</a><a class="navbar__item navbar__link" href="/docs/features/entity-manager">Features</a><a class="navbar__item navbar__link" href="/docs/testing/test-factories">Testing</a><a class="navbar__item navbar__link" href="/docs/faq">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/joist-orm/joist-orm" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://www.youtube.com/@joist-orm" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://discord.gg/ky9VTQugqu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_ki11 colorModeToggle_Hewu"><button class="clean-btn toggleButton_MMFG toggleButtonDisabled_Uw7m" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_lgto"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_U96C"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_bzqh"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_MB5r"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_CLW8 thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_DQfJ margin-bottom--md">Recent posts</div><ul class="sidebarItemList_rvuc clean-list"><li class="sidebarItem__RMN"><a class="sidebarItemLink_Ony9" href="/blog/recursive-relations">Recursive Relations</a></li><li class="sidebarItem__RMN"><a class="sidebarItemLink_Ony9" href="/blog/the-best-orm-ever">Is Joist the Best ORM, Ever?</a></li><li class="sidebarItem__RMN"><a class="sidebarItemLink_Ony9" href="/blog/nextjs-sample-app">New NextJS Sample App</a></li><li class="sidebarItem__RMN"><a class="sidebarItemLink_Ony9" href="/blog/welcome-blog">Welcome</a></li></ul></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="title_Kdtz"><a href="/blog/recursive-relations">Recursive Relations</a></h2><div class="container_iZB2 margin-vert--md"><time datetime="2024-07-20T00:00:00.000Z">July 20, 2024</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_v1VX"><div class="avatar margin-bottom--sm"><a href="https://github.com/stephenh" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/stephenh.png" alt="Stephen Haberman"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/stephenh" target="_blank" rel="noopener noreferrer"><span>Stephen Haberman</span></a></div></div></div></div></div></header><div class="markdown"><p>Joist&#x27;s development is currently very incremental, and doesn&#x27;t have &quot;big release&quot; milestones &amp; release notes, but we recently released a notable new feature: <a href="/docs/advanced/recursive-relations">recursive relations</a>. Check them out! <!-- -->🎉</p></div></article><article class="margin-bottom--xl"><header><h2 class="title_Kdtz"><a href="/blog/the-best-orm-ever">Is Joist the Best ORM, Ever?</a></h2><div class="container_iZB2 margin-vert--md"><time datetime="2024-05-11T00:00:00.000Z">May 11, 2024</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_v1VX"><div class="avatar margin-bottom--sm"><a href="https://github.com/stephenh" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/stephenh.png" alt="Stephen Haberman"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/stephenh" target="_blank" rel="noopener noreferrer"><span>Stephen Haberman</span></a></div></div></div></div></div></header><div class="markdown"><p>I&#x27;ve been working on the Joist docs lately, specifically a <a href="/docs/why-joist">Why Joist?</a> page, which ended up focusing more on &quot;why Domain Models?&quot; than a feature-by-feature description of Joist.</p>
<p>Which is fine, but a good friend (and early Joist user) proofread it, and afterward challenged me that I was being too humble, and I should be more assertive about Joist being &quot;THE BEST ORM FOR TYPESCRIPT AND POSTGRES&quot; (his words), as he listed off his own personal highlights:</p>
<ol>
<li>If it compiles, it works. &quot;If you love TypeScript, you&#x27;ll love Joist.&quot;</li>
<li>It&#x27;s &quot;really effing fast&quot; (<a href="/docs/goals/avoiding-n-plus-1s">no N+1s</a>, ever).</li>
<li>We solve many common problems for you (<a href="/docs/features/entity-manager#auto-batch-updates">auto-batching updates</a>, handling the insertion order of related entities, and have many patterns for <a href="/docs/modeling/enum-tables">enums</a>, <a href="/docs/modeling/relations#polymorphic-references">polymorphic relations</a>, etc.)</li>
<li><a href="/docs/testing/test-factories">Factories</a> make testing amazing.</li>
</ol>
<p>All of these are true.</p>
<p>But in thinking about his challenge, of pitching Joist specifically as &quot;the best ORM for TypeScript &amp; Postgres&quot;, I actually think I can be even more bullish and assert Joist is, currently, <strong>the best ORM, in any language, ever, TypeScript or otherwise</strong>.</p>
<p>Which is crazy, right? How could I possibly assert this?</p>
<p>I have three reasons; admittedly the first two are not technically unique to Joist, but both foundational to its design and implementation, and the third that is one of Joist&#x27;s &quot;special sauces&quot;:</p>
<ol>
<li>JavaScript&#x27;s ability to solve N+1s via the event loop, and</li>
<li>TypeScript&#x27;s ability to model loaded-ness in its type system.</li>
<li>Joist&#x27;s &quot;backend reactivity&quot;</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="no-n1s-javascripts-event-loop">No N+1s: JavaScript&#x27;s Event Loop<a class="hash-link" aria-label="Direct link to No N+1s: JavaScript&#x27;s Event Loop" title="Direct link to No N+1s: JavaScript&#x27;s Event Loop" href="/blog#no-n1s-javascripts-event-loop">​</a></h2>
<p>I&#x27;ve used many ORMs over the years, going back to Java&#x27;s Hibernate, Ruby&#x27;s ActiveRecord, and a few bespoke ones in between.</p>
<p>Invariably, they all suffer from N+1s.</p>
<p>I don&#x27;t want to repeat Joist&#x27;s existing <a href="/docs/goals/avoiding-n-plus-1s">Avoiding N+1s</a> docs, but basically &quot;entities are objects with fields/methods that incrementally lazy-load their relations from the database&quot; is almost &quot;too ergonomic&quot;, and tempts programmers into using the abstraction when they shouldn&#x27;t (i.e. in a loop), at which point N+1s are inevitable.</p>
<p>Again as described in &quot;Avoiding N+1s&quot;, JavaScript&#x27;s event loop forcing all I/O calls to &quot;wait just a sec&quot;, until the end of the event loop tick, gives Joist an amazing opportunity, of course via <a href="https://github.com/graphql/dataloader" target="_blank" rel="noopener noreferrer">dataloader</a>, to de-dupe all the N+1s into a single SQL call.</p>
<p>For everything.</p>
<p>This works so well, that personally <strong>I don&#x27;t know that I ever want to work in a programming language/tech stack that cannot use this trick</strong> (at least to build backend/line-of-business applications).</p>
<p>Granted, JavaScript is not the only language with an event loop--async Rust is a thing, Python has asyncio, and even <a href="https://vertx.io/" target="_blank" rel="noopener noreferrer">Vert.x</a> on the JVM provides it (I prototyped &quot;dataloader ported to Vert.x&quot; several years ago), and either Rust or the JVM (Scala!) would be pretty tempting just in terms of &quot;faster than JavaScript&quot; performance.</p>
<p>But the event loop is only part of the story--another critical part is TypeScript&#x27;s type system.</p>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>Other TypeScript ORMs like Prisma &amp; Drizzle &quot;solve&quot; N+1s by just not modeling your domain as entities (with lazy-loaded relations), and instead force/assume a single/large up-front query that returns an immutable tree of POJOs.</p><p>This does remove the most obvious N+1 footgun (lazy-loaded relations), but it also fundamentally restricts your ability to decompose business logic into smaller/reusable methods, because now any logic that touches the database must be done &quot;in bulk&quot; directly by your code, and often crafted in SQL specifically to how each individual endpoint is accessing the data.</p><p>(Concretely, if you had a <code>saveAuthor</code> endpoint with logic/queries to validate &quot;this author is valid&quot;, and now write a batch <code>saveAuthors</code> endpoint, you could not reuse the &quot;written for one entity&quot; logic without rewriting it to work at the new endpoint&#x27;s grouped/batch level of granularity. Or similar for <code>saveBook</code> logic that you want to use within a <code>saveAuthor</code> that also upserts multiple children books.)</p><p>Instead, Joist&#x27;s auto-batching lets you ergonomically write code at the individual entity abstraction level (whether in a loop, or in per-entity validation rules or lifecycle hooks), but still get performant-by-default batched queries.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="loaded-subgraphs-typescripts-type-system">Loaded Subgraphs: TypeScript&#x27;s Type System<a class="hash-link" aria-label="Direct link to Loaded Subgraphs: TypeScript&#x27;s Type System" title="Direct link to Loaded Subgraphs: TypeScript&#x27;s Type System" href="/blog#loaded-subgraphs-typescripts-type-system">​</a></h2>
<p>After solving N+1s with the event loop, the next biggest ergonomic problem in traditional, entity-based ORMs is tracking (or basically not tracking) loaded-ness in the type system.</p>
<p>Because you can&#x27;t have your entire relational database in memory, domain models must incrementally load their data from the database, as your business logic&#x27;s codepaths decide which parts they need to read.</p>
<p>This was another downfall of the Hibernate/ActiveRecord ORMs: there was no notion of &quot;is this relation loaded yet?&quot;, and so any random relation access could trigger the surprise of an expensive database I/O call, as that relation was lazy-loaded from the database.</p>
<p>Joist solves this by <a href="/docs/goals/load-safe-relations">statically typing all relations</a> as &quot;unloaded&quot; by default, i.e. accessing an Author&#x27;s books requires calling <code>a1.books.load()</code>, which returns a <code>Promise</code> (which is also key to the N+1 prevention above).</p>
<p>Which is great, I/O calls are now obvious, but &quot;do an <code>await</code> for every relation access&quot; would really suck (we tried that), so Joist goes further and uses TypeScript&#x27;s type system to not only track individual relation loaded-ness (like <code>author1.books</code> or <code>book2.authors</code>), but mark <strong>entire subgraphs</strong> of entities as populated/loaded relations and hence synchronously accessible:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Load the Author plus the specific books + reviews subgrpah</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> a1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;a:1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  populate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> books</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> reviews</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;comments&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// a1 is typed as Loaded&lt;Author, { books: { reviews: &quot;comments&quot; } }&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Tada, no more await Promise.all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">books</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">book</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  book</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reviews</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">review</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">review</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">comments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This combination of:</p>
<ul>
<li>Explicit <code>.load()</code> / <code>await</code> calls for any I/O, but leveraging</li>
<li>Mapped types to allow compiler-checked <strong>synchronous</strong> access</li>
</ul>
<p>For me, is also something that <strong>I never want to work without again</strong>. It&#x27;s just so nice.</p>
<p>Unlike JavaScript not having a monopoly on the event loop, for these mapped types I believe TypeScript effectively does have a lock on this capability, from a programming language/type system perspective.</p>
<p>Creating &quot;new types&quot; in other programming languages is generally handled by macros (Scala and Rust), or I suppose Haskell&#x27;s higher-kinded-types. But, as far as I know, none of them can combine TypeScript &quot;mapped type + conditional type&quot; features in a way that would allow this &quot;take my user-defined type (Author)&quot; and &quot;this user-defined populate hint type&quot; and fuse them together into a new type, that is &quot;the author with this specific subgraph of fields marked as loaded&quot;.</p>
<p>I&#x27;m happy to be corrected on this, but I think TypeScript is the only mainstream programming language that can really power Joist&#x27;s <code>Loaded&lt;Author, { books: &quot;reviews&quot; }&gt;</code>-style adhoc typing of subgraphs, or at least this easily.</p>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>Other TypeScript ORMs (Prisma, Drizzle, Kysley, etc.) also leverage TypeScript&#x27;s mapped types to create dynamic shapes of data, which is legitimately great.</p><p>However, they all have the fundamental approach of issuing &quot;one-shot&quot; queries that return immutable trees of POJOs, directly mapped from your SQL tables, and not subgraphs of entities that can have non-SQL abstractions &amp; be further incrementally loaded as/if needed (see <a href="/docs/why-joist">Why Joist</a> for more on this).</p><p>You can generally see, for both issues covered so far (N+1s and statically-typed loaded-ness), most TypeScript ORMs have &quot;solved&quot; these issues by just removing the features all together, and restricting themselves to be &quot;sophisticated query builders&quot;.</p><p>Joist&#x27;s innovation is keeping the entity-based, incremental-loading mental model that is historically very popular/idiomatic for ORMs (particularly Ruby&#x27;s ActiveRecord), and just fundamentally fixing it to not suck.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="joists-backend-reactivity">Joist&#x27;s Backend Reactivity<a class="hash-link" aria-label="Direct link to Joist&#x27;s Backend Reactivity" title="Direct link to Joist&#x27;s Backend Reactivity" href="/blog#joists-backend-reactivity">​</a></h2>
<p>This 3rd section is the first feature that is unique to Joist itself: Joist&#x27;s &quot;backend reactivity&quot;.</p>
<p>Many ORMs have lifecycle hooks (this entity was created, updated, or deleted--which Joist <a href="/docs/modeling/lifecycle-hooks">does as well</a>), to organize side effects/business logic of &quot;when X changes, do Y&quot;.</p>
<p>But just lifecycle hooks by themselves can become tangled, complicated, and a well-known morass of complexity and &quot;spooky action at a distance&quot;.</p>
<p>This is because they&#x27;re basically &quot;Web 1.0&quot; imperative spaghetti code, where you have to manually instrument each mutation that might trigger a side effect.</p>
<p>(Concretely, lets say you have a rule that needs to look at both an author and its books. With raw lifecycle hooks, you must separately instrument both the &quot;author update&quot; and &quot;book update&quot; hooks to call your &quot;make sure this author + books combination is still valid&quot; logic. This can become tedious and error-prone, to get all the right hooks instrumented.)</p>
<p>Instead, Joist&#x27;s <a href="/docs/modeling/reactive-fields">reactive fields</a> and <a href="/docs/modeling/validation-rules">reactive validation rules</a>  take the lessons of &quot;declarative reactivity&quot; from the Mobx/Solid/reactivity-aware frontend world, and bring it to the backend: reactive rules &amp; fields declare in one place what their &quot;upstream dependencies&quot; are, and Joist just handles wiring up the necessary cross-entity reactivity.</p>
<p>This brings a level of ease, specificity, and rigor to what are still effectively lifecycle hooks under the hood, that really makes them pleasant to work with.</p>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>The declarative nature of Joist&#x27;s domain model-wide reactivity graph is also very amenable to DX tooling &amp; documentation generation, but we&#x27;ve not yet deeply explored/delivered any functionality that leverages it.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="conclusion-best-orm-ever">Conclusion: Best ORM Ever?<a class="hash-link" aria-label="Direct link to Conclusion: Best ORM Ever?" title="Direct link to Conclusion: Best ORM Ever?" href="/blog#conclusion-best-orm-ever">​</a></h2>
<p>So, these three features are what back up my exaggerated &quot;best ORM ever&quot; assertion.</p>
<p>If tomorrow, I suddenly could not use Joist, and had to find another ORM to use (or, in general, build any sort of application backend on top of a relational database), in any current/mainstream programming language, without a doubt I would want:</p>
<ol>
<li>Bullet-proof N+1 prevention,</li>
<li>Tracking loaded relation/subgraph state in the type system, and</li>
<li>Backend reactivity, for declarative cross-entity validation rules and reactive fields.</li>
</ol>
<p>And Joist is the only ORM that does all three of these: two of which are uniquely enabled by the JavaScript/TypeScript stack, and the third just part of Joist&#x27;s own innovation.</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="disclaimer-1-uncomfortably-bold-claims">Disclaimer 1: Uncomfortably Bold Claims<a class="hash-link" aria-label="Direct link to Disclaimer 1: Uncomfortably Bold Claims" title="Direct link to Disclaimer 1: Uncomfortably Bold Claims" href="/blog#disclaimer-1-uncomfortably-bold-claims">​</a></h2>
<p>I usually don&#x27;t like making bold/absolutist claims, like &quot;this or that framework is &#x27;the best&#x27;&quot; or &quot;technology x/y/z is terrible&quot; or what not.</p>
<p>I did enough of that early in my career, and at this point I&#x27;m more interested in &quot;what are the trade-offs?&quot; and &quot;what&#x27;s the best tool for this specific use case?&quot;</p>
<p>So, I hold two somewhat incongruent thoughts in my head, as I am both:</p>
<ul>
<li>Very confident that Joist is &quot;the best&quot; way to build application backends on top of a relational database, for a large majority of use cases/teams/codebases, but I also</li>
<li>Recognize it&#x27;s &quot;framework&quot; / entity approach (see <a href="/docs/why-joist">Why Joist</a>) might be either too opinionated or too much abstraction for some people&#x27;s tastes, and just in general choices &amp; alternatives are always great to have.</li>
</ul>
<p>My guess is if you tried Joist, you would quickly come to like it, but it&#x27;s also perfectly fine if not!</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="disclaimer-2-still-a-lot-to-do">Disclaimer 2: Still a Lot To Do<a class="hash-link" aria-label="Direct link to Disclaimer 2: Still a Lot To Do" title="Direct link to Disclaimer 2: Still a Lot To Do" href="/blog#disclaimer-2-still-a-lot-to-do">​</a></h2>
<p>Similar to the two incongruent thoughts above, another two semi-contradictory thoughts is the disclaimer that:</p>
<ul>
<li>Joist&#x27;s core is very solid and vetted by 4+ years of production usage &amp; continual iteration at <a href="https://www.homebound.com/" target="_blank" rel="noopener noreferrer">Homebound</a>, but also</li>
<li>There&#x27;s still a lot of work to do, obviously supporting other databases, but also the myriad fun, incremental improvement ideas we&#x27;re tracking in the issue tracker, and of course even more that we&#x27;ve not thought of yet.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="feedback">Feedback<a class="hash-link" aria-label="Direct link to Feedback" title="Direct link to Feedback" href="/blog#feedback">​</a></h2>
<p>If you have thoughts, questions, or feedback, please let us know! Feel free to join the <a href="https://discord.gg/ky9VTQugqu" target="_blank" rel="noopener noreferrer">Joist discord</a>, or file issues on the GitHub repo if you try Joist and run into any issues.</p>
<p>Despite all the hubris in this post, we are still a very small project &amp; community, and so have a lot of growth and improvement ahead of us.</p>
<p>Thanks for the read!</p></div></article><article class="margin-bottom--xl"><header><h2 class="title_Kdtz"><a href="/blog/nextjs-sample-app">New NextJS Sample App</a></h2><div class="container_iZB2 margin-vert--md"><time datetime="2024-04-21T00:00:00.000Z">April 21, 2024</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_v1VX"><div class="avatar margin-bottom--sm"><a href="https://github.com/stephenh" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/stephenh.png" alt="Stephen Haberman"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/stephenh" target="_blank" rel="noopener noreferrer"><span>Stephen Haberman</span></a></div></div></div></div></div></header><div class="markdown"><p>We&#x27;ve added a new <a href="https://github.com/joist-orm/joist-nextjs-sample/" target="_blank" rel="noopener noreferrer">NextJS + Joist</a> sample app that shows how Joist can be used in a NextJS application, with several benefits:</p>
<ul>
<li>Automatic N+1 Prevention</li>
<li>JSON Payload/Props Creation</li>
<li>Optional Join-based Preloading</li>
</ul>
<p>This post gives a short overview; if you&#x27;d like to watch a video, we also have a <a href="https://youtu.be/H_qJdKUS9D0" target="_blank" rel="noopener noreferrer">YouTube video</a> that walks through the sample app.</p>
<div style="display:grid;place-items:center"><iframe width="750" height="420" src="https://www.youtube.com/embed/H_qJdKUS9D0?si=qUiRr0GTMrQCgayC" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin"></iframe></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="two-render-tree-approaches">Two Render Tree Approaches<a class="hash-link" aria-label="Direct link to Two Render Tree Approaches" title="Direct link to Two Render Tree Approaches" href="/blog#two-render-tree-approaches">​</a></h2>
<p>While building the sample app, we found two fundamental ways of structuring a NextJS app&#x27;s render tree:</p>
<ol>
<li>Fewer React Server Components, that prop drill data to the Client Components<!-- -->
<ul>
<li>Shown on the left, see <code>author-rcc-card.tsx</code> and <code>book-rcc-preview.tsx</code></li>
</ul>
</li>
<li>Mostly React Server Components, with Client Components only at the bottom<!-- -->
<ul>
<li>Shown on the right, see <code>author-rsc-card.tsx</code> and <code>book-rsc-preview.tsx</code></li>
</ul>
</li>
</ol>
<div style="padding:24px"><img src="/images/nextjs-sample-single-multiple-rscs.png"></div>
<p>The top-level <code>Table</code> / <code>table.tsx</code> component renders each of these side-by-side, so we can see the differences, and observe some pros/cons of each approach.</p>
<ul>
<li>
<p>With mostly RSC components, it&#x27;s easy to decompose data loading away from the top-level component.</p>
<p>For example, the <code>AuthorRscCard</code> can make its own data loading calls, and even if it&#x27;s render many pages on the page, Joist will de-dupe across the <code>N</code> sibling <code>AuthorRscCard</code>s, and batch into a single SQL call.</p>
<div class="language-tsx codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-tsx codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">AuthorCardProps</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** RSCs can accept the domain model enities as a prop. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  author</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Author</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">addBook</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/** The RSC version of AuthorCard can load it&#x27;s own data. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AuthorRscCard</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addBook </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">AuthorCardProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// This will be auto-batched if many cards render at once</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> books </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> author</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">books</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Or if you wanted a tree of data, this will also be auto-batched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> loaded </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> author</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">populate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> books</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> reviews</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ratings&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">...jsx</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is nice because it allows the <code>AuthorRscCard</code> to be more self-sufficient, and allow the parent table component to be unaware of its children loading details.</p>
</li>
<li>
<p>With mostly Client components, the opposite happens, and only the parent can make database / <code>EntityManager</code> calls, and so is responsible for loading all the data for its children, and passing it as JSON via props:</p>
<div class="language-tsx codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-tsx codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">AuthorCardProps</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** RCCs must accept a POJO of `Author` + all nested data. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  author</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">AuthorPayload</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">addBook</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/** The RCC version of AuthorCard accepts the `AuthorPayload`. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AuthorRccCard</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addBook </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">AuthorCardProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// can only use data already available on `author` </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Even though the up-front data load can become awkward, it does give more opportunities for optimizations; for example Joist can use join-based preloading to load a single tree of <code>Author</code> + <code>Book</code> + <code>Review</code> entities in a single SQL call, which is even better optimization than the &quot;one query per layer&quot; N+1 prevention of the RSC-based approach.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="automatic-n1-prevention">Automatic N+1 Prevention<a class="hash-link" aria-label="Direct link to Automatic N+1 Prevention" title="Direct link to Automatic N+1 Prevention" href="/blog#automatic-n1-prevention">​</a></h2>
<p>In either approach, Joist&#x27;s N+1 prevention auto-batches database calls, even if they are made across separate component renders. I.e. in the RSC components:</p>
<ul>
<li>The top-level <code>Table</code> component makes 1 SQL call for all <code>Author</code> entities.</li>
<li>All 2nd-level <code>AuthorRscCard</code> cards each make their own <code>author.books.load()</code> (or <code>author.populate(...)</code>) call, but because they&#x27;re all rendered in the same event loop, Joist batches all the <code>load</code> calls into 1 SQL call</li>
<li>Any 3rd-level components would have their <code>load</code> calls batched as well.</li>
</ul>
<p>In the React Client Component approach, this auto-batching is admittedly not as necessary, assuming a singular top-level component, like <code>Table</code>, loads all the data at once anyway (although, as mentioned later, Joist can optimize that as well).</p>
<p>See the <a href="/docs/goals/avoiding-n-plus-1s">Avoiding N+1s</a> section of our docs for more information.</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="json-payloadprops-creation">JSON Payload/Props Creation<a class="hash-link" aria-label="Direct link to JSON Payload/Props Creation" title="Direct link to JSON Payload/Props Creation" href="/blog#json-payloadprops-creation">​</a></h2>
<p>Since the client components cannot make their own async data calls, the top-level <code>Table</code> components is responsible for loading all the data into a JSON payload, and passing it down to the children as props.</p>
<p>Joist entities have an easy way of doing this is, via a <code>toJSON</code> method that takes the shape of data to create:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Define the shape of data to create</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> authorHint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  firstName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  books</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    title</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reviews</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rating&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">customField</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> satisfies JsonHint</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Author</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// This typedef can be used in the client-side props, or to match any</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// endpoint-based respones types like for REST/OpenAPI.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">AuthorPayload</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JsonPayload</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> authorHint</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toJSON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">authorHint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>toJSON</code> implementation will:</p>
<ul>
<li>Load any relations that are not yet loaded from the database</li>
<li>Output only the keys that are requested in the <code>authorHint</code></li>
<li>Call any lambdas like <code>customField</code> to generate custom values</li>
</ul>
<p>As with previous examples, all data loading is N+1 safe, and also potentially join-based preloaded.</p>
<p>See the <a href="/docs/advanced/json-payloads">toJSON</a> docs for more information.</p>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>This recursive <code>toJSON</code> payload generation is a relatively new feature of Joist, so if you have feature ideas that would make it more useful, please let us know!</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="join-based-preloading">Join-Based Preloading<a class="hash-link" aria-label="Direct link to Join-Based Preloading" title="Direct link to Join-Based Preloading" href="/blog#join-based-preloading">​</a></h2>
<p>The last optimization that Joist can do is join-based preloading, which can be used in either the RSC or RCC approach.</p>
<p>This is also a newer feature that requires opt-ing in to, but in <code>em.ts</code> you can add a <code>preloadPlugin</code>:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Returns this request&#x27;s `EntityManager` instance. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> getEm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cache</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Opt-in to preloading</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> preloadPlugin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">JsonAggregatePreloader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">EntityManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preloadPlugin </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will allow Joist to load a deep tree/subgraph of entities in a single SQL call.</p>
<p>For example, normally a Joist <code>em.find</code> a call like:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">populate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> books</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;reviews&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Now access all the data in memory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">books</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reviews</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rating</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Will issue three SQL calls:</p>
<div class="language-sql codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-sql codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> authors </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> books </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> author_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> reviews </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> book_id </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>But with the <code>preloadPlugin</code> enabled, it will use a single SQL call that uses <code>CROSS JOIN LATERAL</code> and <code>json_agg</code> to return the author&#x27;s books, and the book&#x27;s reviews (omitted for brevity) in a single row:</p>
<div class="language-sql codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-sql codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_ </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> _b </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> authors </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">cross</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> lateral</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- create a tuple for each book, and aggregate then into an array of books</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> json_agg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json_build_array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">foreword</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">author_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">order</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> _</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> books _b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">author_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> _b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token keyword" style="color:#00009f">limit</span><span class="token plain"> ?</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>Joist&#x27;s join-based preloading is still a beta feature, so if you run into any issues, please let us know!</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="what-about-complex-queries">What about Complex Queries?<a class="hash-link" aria-label="Direct link to What about Complex Queries?" title="Direct link to What about Complex Queries?" href="/blog#what-about-complex-queries">​</a></h2>
<p>So far, our queries have focused on loading &quot;just entities&quot;, and then putting those on the wire (or rendering them to HTML).</p>
<p>This is because Joist&#x27;s focus is on building robust domain models, and specifically helping solve the &quot;write-side&quot; of your application&#x27;s business logic (running the correct <a href="/docs/modeling/validation-rules">validation rules</a>, <a href="/docs/modeling/lifecycle-hooks">lifecycle hooks</a>, <a href="/docs/modeling/reactive-fields">reactive updates</a>), and less so on the &quot;read-side&quot; of complex queries (i.e. that using aggregates using <code>GROUP BY</code>, multiple nested subqueries/projections/etc.).</p>
<p>As such, Joist does not yet have a sophisticated query builder that can create arbitrary SQL queries, like Kysley or Drizzle.</p>
<p>Instead, Joist encourages an approach that uses its robust write-side features to create materialized columns in the database, such that the majority of your pages/responses really can be served by &quot;super simple <code>SELECT</code> statements&quot;, instead of using complicated queries to calculate aggregates on-the-fly.</p>
<p>Although you can of course use both approaches, and just use a lower-level query builder where needed.</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="sample-app-feedback">Sample App Feedback<a class="hash-link" aria-label="Direct link to Sample App Feedback" title="Direct link to Sample App Feedback" href="/blog#sample-app-feedback">​</a></h2>
<p>Joist&#x27;s roots come from the GraphQL world, so this sample app was our first foray into using it for a NextJS application. If we&#x27;ve missed any key features that would make it easier to use Joist in a NextJS app, please let us know!</p></div></article><article class="margin-bottom--xl"><header><h2 class="title_Kdtz"><a href="/blog/welcome-blog">Welcome</a></h2><div class="container_iZB2 margin-vert--md"><time datetime="2024-04-13T00:00:00.000Z">April 13, 2024</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_v1VX"><div class="avatar margin-bottom--sm"><a href="https://github.com/stephenh" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/stephenh.png" alt="Stephen Haberman"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/stephenh" target="_blank" rel="noopener noreferrer"><span>Stephen Haberman</span></a></div></div></div></div></div></header><div class="markdown"><p>Hello! This is just a &quot;Hello World&quot; post to show the Joist blog, using <a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer"><strong>Docusaurus</strong></a>, is working <!-- -->🎉<!-- -->.</p></div></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/goals">Goals</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/joist-orm/joist-orm/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/ky9VTQugqu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024</div></div></div></footer></div>
</body>
</html>