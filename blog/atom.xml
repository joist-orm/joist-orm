<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://joist-orm.io/blog</id>
    <title>Joist Blog</title>
    <updated>2025-02-17T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://joist-orm.io/blog"/>
    <subtitle>Joist Blog</subtitle>
    <entry>
        <title type="html"><![CDATA[Evolution of Defaults]]></title>
        <id>https://joist-orm.io/blog/evolution-of-defaults</id>
        <link href="https://joist-orm.io/blog/evolution-of-defaults"/>
        <updated>2025-02-17T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Joist's mission is to model your application's business logic, with first-class support for domain modeling features & concepts.]]></summary>
        <content type="html"><![CDATA[<p>Joist's mission is to model your application's business logic, with first-class support for domain modeling features &amp; concepts.</p>
<p>A great example of this is Joist's support for something as simple as default values: for example, the <code>Author.status</code> field should default to <code>Active</code>.</p>
<p>Joist's default values support grew from "the simplest thing possible" (requiring adhoc patterns that engineers would copy/paste around) to a robust, first-class feature (an explicit <code>setDefault</code> API that "just works").</p>
<p>This is a microcosm of Joist's goal to identify the repeated patterns and pain points involved in "building a domain model", and provide elegant features with a great DX.</p>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="version-1-schema-defaults">Version 1. Schema Defaults<a href="https://joist-orm.io/blog/evolution-of-defaults#version-1-schema-defaults" class="hash-link" aria-label="Direct link to Version 1. Schema Defaults" title="Direct link to Version 1. Schema Defaults">â€‹</a></h3>
<p>Joist's initial defaults support was purposefully "as simple as possible", and limited to <code>DEFAULT</code>s declared in the database schema, i.e. an <code>is_archived</code> field that defaults to <code>FALSE</code>, or a <code>status_id</code> that defaults to <code>DRAFT</code>:</p>
<div class="language-sql codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-sql codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> example_table </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id </span><span class="token keyword" style="color:#00009f">SERIAL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    is_archived </span><span class="token keyword" style="color:#00009f">BOOL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    status_id </span><span class="token keyword" style="color:#00009f">INTEGER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Joist's codegen would recognize these, and "apply them immediately" when creating an entity:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toBe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AuthorStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Draft</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// already Draft</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isArchived</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toBe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// already false</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This was super-simple, and had a few pros:</p>
<ul>
<li>Pro: The <code>status</code> is immediately within the <code>em.create</code>
<ul>
<li>I.e. you don't have to wait for an <code>em.flush</code> to "see the database default"</li>
<li>Any business logic can immediately start using the default</li>
</ul>
</li>
<li>Pro: No duplication of "draft is the default" between the database schema &amp; TypeScript code</li>
<li>Con: Only supports static, hard-coded values<!-- -->
<ul>
<li>Ideally we'd like to write lambdas to calculate defaults, based on business logic</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="version-2-beforecreate-hooks">Version 2. beforeCreate hooks<a href="https://joist-orm.io/blog/evolution-of-defaults#version-2-beforecreate-hooks" class="hash-link" aria-label="Direct link to Version 2. beforeCreate hooks" title="Direct link to Version 2. beforeCreate hooks">â€‹</a></h3>
<p>Being limited to static <code>DEFAULT</code> values is not great, so the first way of implementing more complicated "dynamic defaults" was using Joist's <code>beforeCreate</code> hooks:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Any author created w/non-zero amount of books defaults to Published. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authorConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">beforeCreate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"books"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">books</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> AuthorStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Published </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AuthorStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Draft</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This was a quick-win b/c Joist already supported <code>beforeCreate</code> hooks, but had a few cons:</p>
<ul>
<li>Pro: Supports arbitrary business logic<!-- -->
<ul>
<li>The load hint easily enables cross-entity calculations</li>
</ul>
</li>
<li>Con: The default logic isn't ran until <code>em.flush</code>
<ul>
<li>Harder for business logic to rely on</li>
<li>Creates inconsistency between "hard-coded defaults" (applied immediately in <code>em.create</code>) and "dynamic defaults" (applied during <code>flush</code>)</li>
</ul>
</li>
<li>Con: Susceptible to hook ordering issues<!-- -->
<ul>
<li>If our default's value depends on <em>other</em> defaults, it is hard to ensure the other "runs first"</li>
</ul>
</li>
<li>Con: Boilerplate/imperative (not really a first-class feature)<!-- -->
<ul>
<li>The code has to 1st check if <code>a.status</code> is already set (not a huge deal, but boilerplate)</li>
<li>There is nothing in the code/API that identifies "this is a default", instead we just have an adhoc pattern of "this is how our app sets defaults"</li>
</ul>
</li>
<li>Con: Caused duplication with test factories<!-- -->
<ul>
<li>Our test factories often wanted "the same defaults" applied, but Joist's factories are synchronous, which meant any logic that was "set in <code>beforeCreate</code>" wouldn't be seen right away.</li>
<li>To work around this, we often "wrote twice" default logic across our entities &amp; test factories--not great!</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="version-3-adding-setdefault">Version 3: Adding setDefault<a href="https://joist-orm.io/blog/evolution-of-defaults#version-3-adding-setdefault" class="hash-link" aria-label="Direct link to Version 3: Adding setDefault" title="Direct link to Version 3: Adding setDefault">â€‹</a></h3>
<p>We lived with the Version 1 &amp; 2 options for several years, because they were "good enough", but for the 3rd version, we wanted to start "setting defaults" on the road to being "more than just good enough".</p>
<p>Specifically, we wanted a first-class, idiomatic way to "declaratively specify a field's default value" instead of the previous "manually check the field in a <code>beforeCreate</code> hook".</p>
<p>So we added <code>config.setDefault</code>, which accepts the field name, it's dependencies (if any), and a lambda that would calculate the default value:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Calculate the Author.status default, based on number of books. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authorConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"status"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"books"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// a.books.get is available, but a.firstName is not, b/c it's not listed as a dependency</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">books</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> AuthorStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Published </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AuthorStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Draft</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This was a great start, but we pushed it out knowingly half-baked:</p>
<ul>
<li>Pro: Provided scaffolding of a better future<!-- -->
<ul>
<li>Gave an idiomatic way to "declare defaults"</li>
</ul>
</li>
<li>Pro: The type system enforces that the lambda only calls fields explicitly listed in the dependency param<!-- -->
<ul>
<li>This reused our <code>ReactiveField</code> infra and is great for ensuring dependencies aren't missed</li>
</ul>
</li>
<li>Con: The dependencies weren't actually used yet<!-- -->
<ul>
<li>"...ship early!"</li>
</ul>
</li>
<li>Con: <code>setDefault</code> lambdas were still not invoked until <code>em.flush</code>
<ul>
<li>So we still had the "write defaults twice" problem with test factories</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="version-4-dependency-aware">Version 4: Dependency Aware<a href="https://joist-orm.io/blog/evolution-of-defaults#version-4-dependency-aware" class="hash-link" aria-label="Direct link to Version 4: Dependency Aware" title="Direct link to Version 4: Dependency Aware">â€‹</a></h3>
<p>After having the <code>setDefault</code> API in production for a few months, the next improvement was to capitalize on "knowing our dependencies" and allow defaults to depend on other defaults.</p>
<p>For example, maybe our <code>Author.status</code> default needs to know whether any of the books are published (which itself is a default):</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// In `Author.ts`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authorConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"status"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> books</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"status"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> anyBookPublished </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">books</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> BookStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Published</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> anyBookPublished </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> AuthorStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Published </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AuthorStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Draft</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// In `Book.ts`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bookConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"status"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Some business logic that dynamically determines the status</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> BookStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Published</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, if both a <code>Book</code> and an <code>Author</code> are created at the same time, <code>em.flush</code> will ensure that the <code>Book.status</code> is calculated before invoking the <code>Author.status</code> default--<em>we've solved our ordering issue!</em></p>
<p>This was a major accomplishment--cross-entity defaults had been a thorn in our side for years.</p>
<p>(Fwiw we readily admit this is a rare/obscure need--in our domain model of 100s of entities, we have only ~2-3 of these "cross-entity defaults", so we want to be clear this is not necessarily a "must have" feature--but, when you need it, it's extremely nice to have!)</p>
<ul>
<li>Pro: Finally unlocked cross-entity defaults</li>
<li>Con: Still have the "write defaults twice" problem with factories</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="version-5-teaching-factories">Version 5: Teaching Factories!<a href="https://joist-orm.io/blog/evolution-of-defaults#version-5-teaching-factories" class="hash-link" aria-label="Direct link to Version 5: Teaching Factories!" title="Direct link to Version 5: Teaching Factories!">â€‹</a></h3>
<p>The next DX iteration was solving the duplication of "factories want the defaults too!".</p>
<p>Looking more closely at this issue, Joist's test factories are synchronous, which means we can create test data easily without any <code>await</code>s:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Given an author</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newAuthor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">em</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// And a book </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newBook</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">em</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> author</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> a </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// And setup something else using b.title</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...if there is "default title logic", it will not have ran yet, which</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// can be confusing for tests/other logic expecting that behavior </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The lack of <code>await</code>s is very nice! But it does mean, if we really wanted <code>b.title</code> to <em>immediately</em> reflect its production default, we had recode the default logic into the <code>newBook</code> factory:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newBook</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">em</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> EntityManager</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> DeepNew</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Book</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newTestInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">em</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Book</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    title</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"recode the Book default logic here"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As before, for a while this was "good enough"--but finally in this iteration, we taught the factories to leverage their "each test's data is already in memory" advantage and just invoke the defaults immediately during the <code>newTestInstance</code> calls.</p>
<p>This works even for <code>setDefault</code>s that use load hints, like "author status depends on its books":</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// In `Author.ts`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authorConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"status"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> books</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"status"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> anyBookPublished </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">books</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">status </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> BookStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Published</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> anyBookPublished </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> AuthorStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Published </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> AuthorStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Draft</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In production, Joist can't assume "the author's books are already in-memory", so <code>em.flush</code> would first load / <code>await</code> for the <code>a.books</code> to be loaded, and then invoke the lambda.</p>
<p>However, because our tests know that <code>a.books</code> is already in memory, they can skip this <code>await</code>, and immediately invoke the lambda.</p>
<ul>
<li>Pro: We finally can remove the factory's "write it twice" defaults</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="version-next-findorcreates">Version Next: findOrCreates<a href="https://joist-orm.io/blog/evolution-of-defaults#version-next-findorcreates" class="hash-link" aria-label="Direct link to Version Next: findOrCreates" title="Direct link to Version Next: findOrCreates">â€‹</a></h3>
<p>Always looking ahead, the next itch we have is that, currently, default lambdas that call async methods like <code>em.find</code> or <code>em.findOrCreate</code> are still skipped during <code>newTestInstance</code> and only run during <code>em.flush</code>.</p>
<p>Which means, for these defaults, we still have remnants of the "write it twice" defaults anti-pattern--albeit very few of them!</p>
<p>We should be able to lift this restriction as well, with a little bit of work (...maybe <!-- -->ðŸ¤”<!-- -->, the <code>newBook</code> call is fundamentally synchronous, so maybe not).</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="slow-grind-to-perfection">Slow Grind to Perfection<a href="https://joist-orm.io/blog/evolution-of-defaults#slow-grind-to-perfection" class="hash-link" aria-label="Direct link to Slow Grind to Perfection" title="Direct link to Slow Grind to Perfection">â€‹</a></h2>
<p>Wrapping up, besides a "walk down memory lane", the larger point of this post is highlighting Joist's journey of continually grinding on DX polish--we're about five years into <a href="https://www.joelonsoftware.com/2001/07/21/good-software-takes-ten-years-get-used-to-it/" target="_blank" rel="noopener noreferrer">Joel's Good Software Takes 10 Years</a>, so only another 5 to go! <!-- -->ðŸ˜„</p>
<p>Of course, it'd be great for this evolution to happen more quickly--i.e. if we had a dependency-aware, factory-aware, amazing <code>setDefault</code> API from day one.</p>
<p>But, often times jumping to an abstraction can be premature, and result in a rushed design--so sometimes it doesn't hurt to "sit with the itch" for a little while, evolve it through multiple iterations of "good enough", until finally a pleasant/robust solution emerges.</p>
<p>And, perhaps most pragmatically, small iterations helps spread the implementation out over enough hack days that it can actually get shipped. <!-- -->ðŸš¢</p>]]></content>
        <author>
            <name>Stephen Haberman</name>
            <uri>https://github.com/stephenh</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Recursive Relations]]></title>
        <id>https://joist-orm.io/blog/recursive-relations</id>
        <link href="https://joist-orm.io/blog/recursive-relations"/>
        <updated>2024-07-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Joist's development is currently very incremental, and doesn't have "big release" milestones & release notes, but we recently released a notable new featuretada:]]></summary>
        <content type="html"><![CDATA[<p>Joist's development is currently very incremental, and doesn't have "big release" milestones &amp; release notes, but we recently released a notable new feature: <a href="https://joist-orm.io/docs/advanced/recursive-relations">recursive relations</a>. Check them out! <!-- -->ðŸŽ‰</p>]]></content>
        <author>
            <name>Stephen Haberman</name>
            <uri>https://github.com/stephenh</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Is Joist the Best ORM, Ever?]]></title>
        <id>https://joist-orm.io/blog/the-best-orm-ever</id>
        <link href="https://joist-orm.io/blog/the-best-orm-ever"/>
        <updated>2024-05-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[A thought experiment on whether Joist is the best ORM ever.]]></summary>
        <content type="html"><![CDATA[<p>I've been working on the Joist docs lately, specifically a <a href="https://joist-orm.io/docs/why-joist">Why Joist?</a> page, which ended up focusing more on "why Domain Models?" than a feature-by-feature description of Joist.</p>
<p>Which is fine, but a good friend (and early Joist user) proofread it, and afterward challenged me that I was being too humble, and I should be more assertive about Joist being "THE BEST ORM FOR TYPESCRIPT AND POSTGRES" (his words), as he listed off his own personal highlights:</p>
<ol>
<li>If it compiles, it works. "If you love TypeScript, you'll love Joist."</li>
<li>It's "really effing fast" (<a href="https://joist-orm.io/docs/goals/avoiding-n-plus-1s">no N+1s</a>, ever).</li>
<li>We solve many common problems for you (<a href="https://joist-orm.io/docs/features/entity-manager#auto-batch-updates">auto-batching updates</a>, handling the insertion order of related entities, and have many patterns for <a href="https://joist-orm.io/docs/modeling/enum-tables">enums</a>, <a href="https://joist-orm.io/docs/modeling/relations#polymorphic-references">polymorphic relations</a>, etc.)</li>
<li><a href="https://joist-orm.io/docs/testing/test-factories">Factories</a> make testing amazing.</li>
</ol>
<p>All of these are true.</p>
<p>But in thinking about his challenge, of pitching Joist specifically as "the best ORM for TypeScript &amp; Postgres", I actually think I can be even more bullish and assert Joist is, currently, <strong>the best ORM, in any language, ever, TypeScript or otherwise</strong>.</p>
<p>Which is crazy, right? How could I possibly assert this?</p>
<p>I have three reasons; admittedly the first two are not technically unique to Joist, but both foundational to its design and implementation, and the third that is one of Joist's "special sauces":</p>
<ol>
<li>JavaScript's ability to solve N+1s via the event loop, and</li>
<li>TypeScript's ability to model loaded-ness in its type system.</li>
<li>Joist's "backend reactivity"</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="no-n1s-javascripts-event-loop">No N+1s: JavaScript's Event Loop<a href="https://joist-orm.io/blog/the-best-orm-ever#no-n1s-javascripts-event-loop" class="hash-link" aria-label="Direct link to No N+1s: JavaScript's Event Loop" title="Direct link to No N+1s: JavaScript's Event Loop">â€‹</a></h2>
<p>I've used many ORMs over the years, going back to Java's Hibernate, Ruby's ActiveRecord, and a few bespoke ones in between.</p>
<p>Invariably, they all suffer from N+1s.</p>
<p>I don't want to repeat Joist's existing <a href="https://joist-orm.io/docs/goals/avoiding-n-plus-1s">Avoiding N+1s</a> docs, but basically "entities are objects with fields/methods that incrementally lazy-load their relations from the database" is almost "too ergonomic", and tempts programmers into using the abstraction when they shouldn't (i.e. in a loop), at which point N+1s are inevitable.</p>
<p>Again as described in "Avoiding N+1s", JavaScript's event loop forcing all I/O calls to "wait just a sec", until the end of the event loop tick, gives Joist an amazing opportunity, of course via <a href="https://github.com/graphql/dataloader" target="_blank" rel="noopener noreferrer">dataloader</a>, to de-dupe all the N+1s into a single SQL call.</p>
<p>For everything.</p>
<p>This works so well, that personally <strong>I don't know that I ever want to work in a programming language/tech stack that cannot use this trick</strong> (at least to build backend/line-of-business applications).</p>
<p>Granted, JavaScript is not the only language with an event loop--async Rust is a thing, Python has asyncio, and even <a href="https://vertx.io/" target="_blank" rel="noopener noreferrer">Vert.x</a> on the JVM provides it (I prototyped "dataloader ported to Vert.x" several years ago), and either Rust or the JVM (Scala!) would be pretty tempting just in terms of "faster than JavaScript" performance.</p>
<p>But the event loop is only part of the story--another critical part is TypeScript's type system.</p>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>Other TypeScript ORMs like Prisma &amp; Drizzle "solve" N+1s by just not modeling your domain as entities (with lazy-loaded relations), and instead force/assume a single/large up-front query that returns an immutable tree of POJOs.</p><p>This does remove the most obvious N+1 footgun (lazy-loaded relations), but it also fundamentally restricts your ability to decompose business logic into smaller/reusable methods, because now any logic that touches the database must be done "in bulk" directly by your code, and often crafted in SQL specifically to how each individual endpoint is accessing the data.</p><p>(Concretely, if you had a <code>saveAuthor</code> endpoint with logic/queries to validate "this author is valid", and now write a batch <code>saveAuthors</code> endpoint, you could not reuse the "written for one entity" logic without rewriting it to work at the new endpoint's grouped/batch level of granularity. Or similar for <code>saveBook</code> logic that you want to use within a <code>saveAuthor</code> that also upserts multiple children books.)</p><p>Instead, Joist's auto-batching lets you ergonomically write code at the individual entity abstraction level (whether in a loop, or in per-entity validation rules or lifecycle hooks), but still get performant-by-default batched queries.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="loaded-subgraphs-typescripts-type-system">Loaded Subgraphs: TypeScript's Type System<a href="https://joist-orm.io/blog/the-best-orm-ever#loaded-subgraphs-typescripts-type-system" class="hash-link" aria-label="Direct link to Loaded Subgraphs: TypeScript's Type System" title="Direct link to Loaded Subgraphs: TypeScript's Type System">â€‹</a></h2>
<p>After solving N+1s with the event loop, the next biggest ergonomic problem in traditional, entity-based ORMs is tracking (or basically not tracking) loaded-ness in the type system.</p>
<p>Because you can't have your entire relational database in memory, domain models must incrementally load their data from the database, as your business logic's codepaths decide which parts they need to read.</p>
<p>This was another downfall of the Hibernate/ActiveRecord ORMs: there was no notion of "is this relation loaded yet?", and so any random relation access could trigger the surprise of an expensive database I/O call, as that relation was lazy-loaded from the database.</p>
<p>Joist solves this by <a href="https://joist-orm.io/docs/goals/load-safe-relations">statically typing all relations</a> as "unloaded" by default, i.e. accessing an Author's books requires calling <code>a1.books.load()</code>, which returns a <code>Promise</code> (which is also key to the N+1 prevention above).</p>
<p>Which is great, I/O calls are now obvious, but "do an <code>await</code> for every relation access" would really suck (we tried that), so Joist goes further and uses TypeScript's type system to not only track individual relation loaded-ness (like <code>author1.books</code> or <code>book2.authors</code>), but mark <strong>entire subgraphs</strong> of entities as populated/loaded relations and hence synchronously accessible:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Load the Author plus the specific books + reviews subgrpah</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> a1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"a:1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  populate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> books</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> reviews</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"comments"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// a1 is typed as Loaded&lt;Author, { books: { reviews: "comments" } }&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Tada, no more await Promise.all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">books</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">book</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  book</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reviews</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">review</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">review</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">comments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This combination of:</p>
<ul>
<li>Explicit <code>.load()</code> / <code>await</code> calls for any I/O, but leveraging</li>
<li>Mapped types to allow compiler-checked <strong>synchronous</strong> access</li>
</ul>
<p>For me, is also something that <strong>I never want to work without again</strong>. It's just so nice.</p>
<p>Unlike JavaScript not having a monopoly on the event loop, for these mapped types I believe TypeScript effectively does have a lock on this capability, from a programming language/type system perspective.</p>
<p>Creating "new types" in other programming languages is generally handled by macros (Scala and Rust), or I suppose Haskell's higher-kinded-types. But, as far as I know, none of them can combine TypeScript "mapped type + conditional type" features in a way that would allow this "take my user-defined type (Author)" and "this user-defined populate hint type" and fuse them together into a new type, that is "the author with this specific subgraph of fields marked as loaded".</p>
<p>I'm happy to be corrected on this, but I think TypeScript is the only mainstream programming language that can really power Joist's <code>Loaded&lt;Author, { books: "reviews" }&gt;</code>-style adhoc typing of subgraphs, or at least this easily.</p>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>Other TypeScript ORMs (Prisma, Drizzle, Kysley, etc.) also leverage TypeScript's mapped types to create dynamic shapes of data, which is legitimately great.</p><p>However, they all have the fundamental approach of issuing "one-shot" queries that return immutable trees of POJOs, directly mapped from your SQL tables, and not subgraphs of entities that can have non-SQL abstractions &amp; be further incrementally loaded as/if needed (see <a href="https://joist-orm.io/docs/why-joist">Why Joist</a> for more on this).</p><p>You can generally see, for both issues covered so far (N+1s and statically-typed loaded-ness), most TypeScript ORMs have "solved" these issues by just removing the features all together, and restricting themselves to be "sophisticated query builders".</p><p>Joist's innovation is keeping the entity-based, incremental-loading mental model that is historically very popular/idiomatic for ORMs (particularly Ruby's ActiveRecord), and just fundamentally fixing it to not suck.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="joists-backend-reactivity">Joist's Backend Reactivity<a href="https://joist-orm.io/blog/the-best-orm-ever#joists-backend-reactivity" class="hash-link" aria-label="Direct link to Joist's Backend Reactivity" title="Direct link to Joist's Backend Reactivity">â€‹</a></h2>
<p>This 3rd section is the first feature that is unique to Joist itself: Joist's "backend reactivity".</p>
<p>Many ORMs have lifecycle hooks (this entity was created, updated, or deleted--which Joist <a href="https://joist-orm.io/docs/modeling/lifecycle-hooks">does as well</a>), to organize side effects/business logic of "when X changes, do Y".</p>
<p>But just lifecycle hooks by themselves can become tangled, complicated, and a well-known morass of complexity and "spooky action at a distance".</p>
<p>This is because they're basically "Web 1.0" imperative spaghetti code, where you have to manually instrument each mutation that might trigger a side effect.</p>
<p>(Concretely, lets say you have a rule that needs to look at both an author and its books. With raw lifecycle hooks, you must separately instrument both the "author update" and "book update" hooks to call your "make sure this author + books combination is still valid" logic. This can become tedious and error-prone, to get all the right hooks instrumented.)</p>
<p>Instead, Joist's <a href="https://joist-orm.io/docs/modeling/reactive-fields">reactive fields</a> and <a href="https://joist-orm.io/docs/modeling/validation-rules">reactive validation rules</a>  take the lessons of "declarative reactivity" from the Mobx/Solid/reactivity-aware frontend world, and bring it to the backend: reactive rules &amp; fields declare in one place what their "upstream dependencies" are, and Joist just handles wiring up the necessary cross-entity reactivity.</p>
<p>This brings a level of ease, specificity, and rigor to what are still effectively lifecycle hooks under the hood, that really makes them pleasant to work with.</p>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>The declarative nature of Joist's domain model-wide reactivity graph is also very amenable to DX tooling &amp; documentation generation, but we've not yet deeply explored/delivered any functionality that leverages it.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="conclusion-best-orm-ever">Conclusion: Best ORM Ever?<a href="https://joist-orm.io/blog/the-best-orm-ever#conclusion-best-orm-ever" class="hash-link" aria-label="Direct link to Conclusion: Best ORM Ever?" title="Direct link to Conclusion: Best ORM Ever?">â€‹</a></h2>
<p>So, these three features are what back up my exaggerated "best ORM ever" assertion.</p>
<p>If tomorrow, I suddenly could not use Joist, and had to find another ORM to use (or, in general, build any sort of application backend on top of a relational database), in any current/mainstream programming language, without a doubt I would want:</p>
<ol>
<li>Bullet-proof N+1 prevention,</li>
<li>Tracking loaded relation/subgraph state in the type system, and</li>
<li>Backend reactivity, for declarative cross-entity validation rules and reactive fields.</li>
</ol>
<p>And Joist is the only ORM that does all three of these: two of which are uniquely enabled by the JavaScript/TypeScript stack, and the third just part of Joist's own innovation.</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="disclaimer-1-uncomfortably-bold-claims">Disclaimer 1: Uncomfortably Bold Claims<a href="https://joist-orm.io/blog/the-best-orm-ever#disclaimer-1-uncomfortably-bold-claims" class="hash-link" aria-label="Direct link to Disclaimer 1: Uncomfortably Bold Claims" title="Direct link to Disclaimer 1: Uncomfortably Bold Claims">â€‹</a></h2>
<p>I usually don't like making bold/absolutist claims, like "this or that framework is 'the best'" or "technology x/y/z is terrible" or what not.</p>
<p>I did enough of that early in my career, and at this point I'm more interested in "what are the trade-offs?" and "what's the best tool for this specific use case?"</p>
<p>So, I hold two somewhat incongruent thoughts in my head, as I am both:</p>
<ul>
<li>Very confident that Joist is "the best" way to build application backends on top of a relational database, for a large majority of use cases/teams/codebases, but I also</li>
<li>Recognize it's "framework" / entity approach (see <a href="https://joist-orm.io/docs/why-joist">Why Joist</a>) might be either too opinionated or too much abstraction for some people's tastes, and just in general choices &amp; alternatives are always great to have.</li>
</ul>
<p>My guess is if you tried Joist, you would quickly come to like it, but it's also perfectly fine if not!</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="disclaimer-2-still-a-lot-to-do">Disclaimer 2: Still a Lot To Do<a href="https://joist-orm.io/blog/the-best-orm-ever#disclaimer-2-still-a-lot-to-do" class="hash-link" aria-label="Direct link to Disclaimer 2: Still a Lot To Do" title="Direct link to Disclaimer 2: Still a Lot To Do">â€‹</a></h2>
<p>Similar to the two incongruent thoughts above, another two semi-contradictory thoughts is the disclaimer that:</p>
<ul>
<li>Joist's core is very solid and vetted by 4+ years of production usage &amp; continual iteration at <a href="https://www.homebound.com/" target="_blank" rel="noopener noreferrer">Homebound</a>, but also</li>
<li>There's still a lot of work to do, obviously supporting other databases, but also the myriad fun, incremental improvement ideas we're tracking in the issue tracker, and of course even more that we've not thought of yet.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="feedback">Feedback<a href="https://joist-orm.io/blog/the-best-orm-ever#feedback" class="hash-link" aria-label="Direct link to Feedback" title="Direct link to Feedback">â€‹</a></h2>
<p>If you have thoughts, questions, or feedback, please let us know! Feel free to join the <a href="https://discord.gg/ky9VTQugqu" target="_blank" rel="noopener noreferrer">Joist discord</a>, or file issues on the GitHub repo if you try Joist and run into any issues.</p>
<p>Despite all the hubris in this post, we are still a very small project &amp; community, and so have a lot of growth and improvement ahead of us.</p>
<p>Thanks for the read!</p>]]></content>
        <author>
            <name>Stephen Haberman</name>
            <uri>https://github.com/stephenh</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[New NextJS Sample App]]></title>
        <id>https://joist-orm.io/blog/nextjs-sample-app</id>
        <link href="https://joist-orm.io/blog/nextjs-sample-app"/>
        <updated>2024-04-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We've added a new NextJS sample app to the Joist repository.]]></summary>
        <content type="html"><![CDATA[<p>We've added a new <a href="https://github.com/joist-orm/joist-nextjs-sample/" target="_blank" rel="noopener noreferrer">NextJS + Joist</a> sample app that shows how Joist can be used in a NextJS application, with several benefits:</p>
<ul>
<li>Automatic N+1 Prevention</li>
<li>JSON Payload/Props Creation</li>
<li>Optional Join-based Preloading</li>
</ul>
<p>This post gives a short overview; if you'd like to watch a video, we also have a <a href="https://youtu.be/H_qJdKUS9D0" target="_blank" rel="noopener noreferrer">YouTube video</a> that walks through the sample app.</p>
<div style="display:grid;place-items:center"><iframe width="750" height="420" src="https://www.youtube.com/embed/H_qJdKUS9D0?si=qUiRr0GTMrQCgayC" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin"></iframe></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="two-render-tree-approaches">Two Render Tree Approaches<a href="https://joist-orm.io/blog/nextjs-sample-app#two-render-tree-approaches" class="hash-link" aria-label="Direct link to Two Render Tree Approaches" title="Direct link to Two Render Tree Approaches">â€‹</a></h2>
<p>While building the sample app, we found two fundamental ways of structuring a NextJS app's render tree:</p>
<ol>
<li>Fewer React Server Components, that prop drill data to the Client Components<!-- -->
<ul>
<li>Shown on the left, see <code>author-rcc-card.tsx</code> and <code>book-rcc-preview.tsx</code></li>
</ul>
</li>
<li>Mostly React Server Components, with Client Components only at the bottom<!-- -->
<ul>
<li>Shown on the right, see <code>author-rsc-card.tsx</code> and <code>book-rsc-preview.tsx</code></li>
</ul>
</li>
</ol>
<div style="padding:24px"><img src="https://joist-orm.io/images/nextjs-sample-single-multiple-rscs.png"></div>
<p>The top-level <code>Table</code> / <code>table.tsx</code> component renders each of these side-by-side, so we can see the differences, and observe some pros/cons of each approach.</p>
<ul>
<li>
<p>With mostly RSC components, it's easy to decompose data loading away from the top-level component.</p>
<p>For example, the <code>AuthorRscCard</code> can make its own data loading calls, and even if it's render many pages on the page, Joist will de-dupe across the <code>N</code> sibling <code>AuthorRscCard</code>s, and batch into a single SQL call.</p>
<div class="language-tsx codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-tsx codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">AuthorCardProps</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** RSCs can accept the domain model enities as a prop. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  author</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Author</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">addBook</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/** The RSC version of AuthorCard can load it's own data. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AuthorRscCard</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addBook </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">AuthorCardProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// This will be auto-batched if many cards render at once</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> books </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> author</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">books</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Or if you wanted a tree of data, this will also be auto-batched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> loaded </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> author</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">populate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> books</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> reviews</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ratings"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">...jsx</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is nice because it allows the <code>AuthorRscCard</code> to be more self-sufficient, and allow the parent table component to be unaware of its children loading details.</p>
</li>
<li>
<p>With mostly Client components, the opposite happens, and only the parent can make database / <code>EntityManager</code> calls, and so is responsible for loading all the data for its children, and passing it as JSON via props:</p>
<div class="language-tsx codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-tsx codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">AuthorCardProps</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** RCCs must accept a POJO of `Author` + all nested data. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  author</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">AuthorPayload</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">addBook</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/** The RCC version of AuthorCard accepts the `AuthorPayload`. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AuthorRccCard</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addBook </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">AuthorCardProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// can only use data already available on `author` </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Even though the up-front data load can become awkward, it does give more opportunities for optimizations; for example Joist can use join-based preloading to load a single tree of <code>Author</code> + <code>Book</code> + <code>Review</code> entities in a single SQL call, which is even better optimization than the "one query per layer" N+1 prevention of the RSC-based approach.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="automatic-n1-prevention">Automatic N+1 Prevention<a href="https://joist-orm.io/blog/nextjs-sample-app#automatic-n1-prevention" class="hash-link" aria-label="Direct link to Automatic N+1 Prevention" title="Direct link to Automatic N+1 Prevention">â€‹</a></h2>
<p>In either approach, Joist's N+1 prevention auto-batches database calls, even if they are made across separate component renders. I.e. in the RSC components:</p>
<ul>
<li>The top-level <code>Table</code> component makes 1 SQL call for all <code>Author</code> entities.</li>
<li>All 2nd-level <code>AuthorRscCard</code> cards each make their own <code>author.books.load()</code> (or <code>author.populate(...)</code>) call, but because they're all rendered in the same event loop, Joist batches all the <code>load</code> calls into 1 SQL call</li>
<li>Any 3rd-level components would have their <code>load</code> calls batched as well.</li>
</ul>
<p>In the React Client Component approach, this auto-batching is admittedly not as necessary, assuming a singular top-level component, like <code>Table</code>, loads all the data at once anyway (although, as mentioned later, Joist can optimize that as well).</p>
<p>See the <a href="https://joist-orm.io/docs/goals/avoiding-n-plus-1s">Avoiding N+1s</a> section of our docs for more information.</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="json-payloadprops-creation">JSON Payload/Props Creation<a href="https://joist-orm.io/blog/nextjs-sample-app#json-payloadprops-creation" class="hash-link" aria-label="Direct link to JSON Payload/Props Creation" title="Direct link to JSON Payload/Props Creation">â€‹</a></h2>
<p>Since the client components cannot make their own async data calls, the top-level <code>Table</code> components is responsible for loading all the data into a JSON payload, and passing it down to the children as props.</p>
<p>Joist entities have an easy way of doing this is, via a <code>toJSON</code> method that takes the shape of data to create:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Define the shape of data to create</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> authorHint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  firstName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  books</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    title</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reviews</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"id"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"rating"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">customField</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> satisfies JsonHint</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Author</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// This typedef can be used in the client-side props, or to match any</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// endpoint-based respones types like for REST/OpenAPI.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">AuthorPayload</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JsonPayload</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> authorHint</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toJSON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">authorHint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>toJSON</code> implementation will:</p>
<ul>
<li>Load any relations that are not yet loaded from the database</li>
<li>Output only the keys that are requested in the <code>authorHint</code></li>
<li>Call any lambdas like <code>customField</code> to generate custom values</li>
</ul>
<p>As with previous examples, all data loading is N+1 safe, and also potentially join-based preloaded.</p>
<p>See the <a href="https://joist-orm.io/docs/advanced/json-payloads">toJSON</a> docs for more information.</p>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>This recursive <code>toJSON</code> payload generation is a relatively new feature of Joist, so if you have feature ideas that would make it more useful, please let us know!</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="join-based-preloading">Join-Based Preloading<a href="https://joist-orm.io/blog/nextjs-sample-app#join-based-preloading" class="hash-link" aria-label="Direct link to Join-Based Preloading" title="Direct link to Join-Based Preloading">â€‹</a></h2>
<p>The last optimization that Joist can do is join-based preloading, which can be used in either the RSC or RCC approach.</p>
<p>This is also a newer feature that requires opt-ing in to, but in <code>em.ts</code> you can add a <code>preloadPlugin</code>:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Returns this request's `EntityManager` instance. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> getEm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cache</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Opt-in to preloading</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> preloadPlugin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">JsonAggregatePreloader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">EntityManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preloadPlugin </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will allow Joist to load a deep tree/subgraph of entities in a single SQL call.</p>
<p>For example, normally a Joist <code>em.find</code> a call like:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">populate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> books</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"reviews"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Now access all the data in memory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">books</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reviews</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rating</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Will issue three SQL calls:</p>
<div class="language-sql codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-sql codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> authors </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> books </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> author_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> reviews </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> book_id </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>But with the <code>preloadPlugin</code> enabled, it will use a single SQL call that uses <code>CROSS JOIN LATERAL</code> and <code>json_agg</code> to return the author's books, and the book's reviews (omitted for brevity) in a single row:</p>
<div class="language-sql codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-sql codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_ </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> _b </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> authors </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">cross</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> lateral</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- create a tuple for each book, and aggregate then into an array of books</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> json_agg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json_build_array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">foreword</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">author_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">order</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> _</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> books _b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">author_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> _b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token keyword" style="color:#00009f">limit</span><span class="token plain"> ?</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>Joist's join-based preloading is still a beta feature, so if you run into any issues, please let us know!</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="what-about-complex-queries">What about Complex Queries?<a href="https://joist-orm.io/blog/nextjs-sample-app#what-about-complex-queries" class="hash-link" aria-label="Direct link to What about Complex Queries?" title="Direct link to What about Complex Queries?">â€‹</a></h2>
<p>So far, our queries have focused on loading "just entities", and then putting those on the wire (or rendering them to HTML).</p>
<p>This is because Joist's focus is on building robust domain models, and specifically helping solve the "write-side" of your application's business logic (running the correct <a href="https://joist-orm.io/docs/modeling/validation-rules">validation rules</a>, <a href="https://joist-orm.io/docs/modeling/lifecycle-hooks">lifecycle hooks</a>, <a href="https://joist-orm.io/docs/modeling/reactive-fields">reactive updates</a>), and less so on the "read-side" of complex queries (i.e. that using aggregates using <code>GROUP BY</code>, multiple nested subqueries/projections/etc.).</p>
<p>As such, Joist does not yet have a sophisticated query builder that can create arbitrary SQL queries, like Kysley or Drizzle.</p>
<p>Instead, Joist encourages an approach that uses its robust write-side features to create materialized columns in the database, such that the majority of your pages/responses really can be served by "super simple <code>SELECT</code> statements", instead of using complicated queries to calculate aggregates on-the-fly.</p>
<p>Although you can of course use both approaches, and just use a lower-level query builder where needed.</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="sample-app-feedback">Sample App Feedback<a href="https://joist-orm.io/blog/nextjs-sample-app#sample-app-feedback" class="hash-link" aria-label="Direct link to Sample App Feedback" title="Direct link to Sample App Feedback">â€‹</a></h2>
<p>Joist's roots come from the GraphQL world, so this sample app was our first foray into using it for a NextJS application. If we've missed any key features that would make it easier to use Joist in a NextJS app, please let us know!</p>]]></content>
        <author>
            <name>Stephen Haberman</name>
            <uri>https://github.com/stephenh</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Welcome]]></title>
        <id>https://joist-orm.io/blog/welcome-blog</id>
        <link href="https://joist-orm.io/blog/welcome-blog"/>
        <updated>2024-04-13T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[First post on the Joist blog.]]></summary>
        <content type="html"><![CDATA[<p>Hello! This is just a "Hello World" post to show the Joist blog, using <a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer"><strong>Docusaurus</strong></a>, is working <!-- -->ðŸŽ‰<!-- -->.</p>]]></content>
        <author>
            <name>Stephen Haberman</name>
            <uri>https://github.com/stephenh</uri>
        </author>
    </entry>
</feed>