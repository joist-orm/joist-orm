<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Joist Blog</title>
        <link>https://joist-orm.io/blog</link>
        <description>Joist Blog</description>
        <lastBuildDate>Sat, 20 Jul 2024 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Recursive Relations]]></title>
            <link>https://joist-orm.io/blog/recursive-relations</link>
            <guid>https://joist-orm.io/blog/recursive-relations</guid>
            <pubDate>Sat, 20 Jul 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[Joist's development is currently very incremental, and doesn't have "big release" milestones & release notes, but we recently released a notable new featuretada:]]></description>
            <content:encoded><![CDATA[<p>Joist's development is currently very incremental, and doesn't have "big release" milestones &amp; release notes, but we recently released a notable new feature: <a href="https://joist-orm.io/docs/advanced/recursive-relations">recursive relations</a>. Check them out! <!-- -->ðŸŽ‰</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Is Joist the Best ORM, Ever?]]></title>
            <link>https://joist-orm.io/blog/the-best-orm-ever</link>
            <guid>https://joist-orm.io/blog/the-best-orm-ever</guid>
            <pubDate>Sat, 11 May 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[A thought experiment on whether Joist is the best ORM ever.]]></description>
            <content:encoded><![CDATA[<p>I've been working on the Joist docs lately, specifically a <a href="https://joist-orm.io/docs/why-joist">Why Joist?</a> page, which ended up focusing more on "why Domain Models?" than a feature-by-feature description of Joist.</p>
<p>Which is fine, but a good friend (and early Joist user) proofread it, and afterward challenged me that I was being too humble, and I should be more assertive about Joist being "THE BEST ORM FOR TYPESCRIPT AND POSTGRES" (his words), as he listed off his own personal highlights:</p>
<ol>
<li>If it compiles, it works. "If you love TypeScript, you'll love Joist."</li>
<li>It's "really effing fast" (<a href="https://joist-orm.io/docs/goals/avoiding-n-plus-1s">no N+1s</a>, ever).</li>
<li>We solve many common problems for you (<a href="https://joist-orm.io/docs/features/entity-manager#auto-batch-updates">auto-batching updates</a>, handling the insertion order of related entities, and have many patterns for <a href="https://joist-orm.io/docs/modeling/enum-tables">enums</a>, <a href="https://joist-orm.io/docs/modeling/relations#polymorphic-references">polymorphic relations</a>, etc.)</li>
<li><a href="https://joist-orm.io/docs/testing/test-factories">Factories</a> make testing amazing.</li>
</ol>
<p>All of these are true.</p>
<p>But in thinking about his challenge, of pitching Joist specifically as "the best ORM for TypeScript &amp; Postgres", I actually think I can be even more bullish and assert Joist is, currently, <strong>the best ORM, in any language, ever, TypeScript or otherwise</strong>.</p>
<p>Which is crazy, right? How could I possibly assert this?</p>
<p>I have three reasons; admittedly the first two are not technically unique to Joist, but both foundational to its design and implementation, and the third that is one of Joist's "special sauces":</p>
<ol>
<li>JavaScript's ability to solve N+1s via the event loop, and</li>
<li>TypeScript's ability to model loaded-ness in its type system.</li>
<li>Joist's "backend reactivity"</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="no-n1s-javascripts-event-loop">No N+1s: JavaScript's Event Loop<a href="https://joist-orm.io/blog/the-best-orm-ever#no-n1s-javascripts-event-loop" class="hash-link" aria-label="Direct link to No N+1s: JavaScript's Event Loop" title="Direct link to No N+1s: JavaScript's Event Loop">â€‹</a></h2>
<p>I've used many ORMs over the years, going back to Java's Hibernate, Ruby's ActiveRecord, and a few bespoke ones in between.</p>
<p>Invariably, they all suffer from N+1s.</p>
<p>I don't want to repeat Joist's existing <a href="https://joist-orm.io/docs/goals/avoiding-n-plus-1s">Avoiding N+1s</a> docs, but basically "entities are objects with fields/methods that incrementally lazy-load their relations from the database" is almost "too ergonomic", and tempts programmers into using the abstraction when they shouldn't (i.e. in a loop), at which point N+1s are inevitable.</p>
<p>Again as described in "Avoiding N+1s", JavaScript's event loop forcing all I/O calls to "wait just a sec", until the end of the event loop tick, gives Joist an amazing opportunity, of course via <a href="https://github.com/graphql/dataloader" target="_blank" rel="noopener noreferrer">dataloader</a>, to de-dupe all the N+1s into a single SQL call.</p>
<p>For everything.</p>
<p>This works so well, that personally <strong>I don't know that I ever want to work in a programming language/tech stack that cannot use this trick</strong> (at least to build backend/line-of-business applications).</p>
<p>Granted, JavaScript is not the only language with an event loop--async Rust is a thing, Python has asyncio, and even <a href="https://vertx.io/" target="_blank" rel="noopener noreferrer">Vert.x</a> on the JVM provides it (I prototyped "dataloader ported to Vert.x" several years ago), and either Rust or the JVM (Scala!) would be pretty tempting just in terms of "faster than JavaScript" performance.</p>
<p>But the event loop is only part of the story--another critical part is TypeScript's type system.</p>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>Other TypeScript ORMs like Prisma &amp; Drizzle "solve" N+1s by just not modeling your domain as entities (with lazy-loaded relations), and instead force/assume a single/large up-front query that returns an immutable tree of POJOs.</p><p>This does remove the most obvious N+1 footgun (lazy-loaded relations), but it also fundamentally restricts your ability to decompose business logic into smaller/reusable methods, because now any logic that touches the database must be done "in bulk" directly by your code, and often crafted in SQL specifically to how each individual endpoint is accessing the data.</p><p>(Concretely, if you had a <code>saveAuthor</code> endpoint with logic/queries to validate "this author is valid", and now write a batch <code>saveAuthors</code> endpoint, you could not reuse the "written for one entity" logic without rewriting it to work at the new endpoint's grouped/batch level of granularity. Or similar for <code>saveBook</code> logic that you want to use within a <code>saveAuthor</code> that also upserts multiple children books.)</p><p>Instead, Joist's auto-batching lets you ergonomically write code at the individual entity abstraction level (whether in a loop, or in per-entity validation rules or lifecycle hooks), but still get performant-by-default batched queries.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="loaded-subgraphs-typescripts-type-system">Loaded Subgraphs: TypeScript's Type System<a href="https://joist-orm.io/blog/the-best-orm-ever#loaded-subgraphs-typescripts-type-system" class="hash-link" aria-label="Direct link to Loaded Subgraphs: TypeScript's Type System" title="Direct link to Loaded Subgraphs: TypeScript's Type System">â€‹</a></h2>
<p>After solving N+1s with the event loop, the next biggest ergonomic problem in traditional, entity-based ORMs is tracking (or basically not tracking) loaded-ness in the type system.</p>
<p>Because you can't have your entire relational database in memory, domain models must incrementally load their data from the database, as your business logic's codepaths decide which parts they need to read.</p>
<p>This was another downfall of the Hibernate/ActiveRecord ORMs: there was no notion of "is this relation loaded yet?", and so any random relation access could trigger the surprise of an expensive database I/O call, as that relation was lazy-loaded from the database.</p>
<p>Joist solves this by <a href="https://joist-orm.io/docs/goals/load-safe-relations">statically typing all relations</a> as "unloaded" by default, i.e. accessing an Author's books requires calling <code>a1.books.load()</code>, which returns a <code>Promise</code> (which is also key to the N+1 prevention above).</p>
<p>Which is great, I/O calls are now obvious, but "do an <code>await</code> for every relation access" would really suck (we tried that), so Joist goes further and uses TypeScript's type system to not only track individual relation loaded-ness (like <code>author1.books</code> or <code>book2.authors</code>), but mark <strong>entire subgraphs</strong> of entities as populated/loaded relations and hence synchronously accessible:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Load the Author plus the specific books + reviews subgrpah</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> a1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"a:1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  populate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> books</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> reviews</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"comments"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// a1 is typed as Loaded&lt;Author, { books: { reviews: "comments" } }&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Tada, no more await Promise.all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">books</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">book</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  book</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reviews</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">forEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">review</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">review</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">comments</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This combination of:</p>
<ul>
<li>Explicit <code>.load()</code> / <code>await</code> calls for any I/O, but leveraging</li>
<li>Mapped types to allow compiler-checked <strong>synchronous</strong> access</li>
</ul>
<p>For me, is also something that <strong>I never want to work without again</strong>. It's just so nice.</p>
<p>Unlike JavaScript not having a monopoly on the event loop, for these mapped types I believe TypeScript effectively does have a lock on this capability, from a programming language/type system perspective.</p>
<p>Creating "new types" in other programming languages is generally handled by macros (Scala and Rust), or I suppose Haskell's higher-kinded-types. But, as far as I know, none of them can combine TypeScript "mapped type + conditional type" features in a way that would allow this "take my user-defined type (Author)" and "this user-defined populate hint type" and fuse them together into a new type, that is "the author with this specific subgraph of fields marked as loaded".</p>
<p>I'm happy to be corrected on this, but I think TypeScript is the only mainstream programming language that can really power Joist's <code>Loaded&lt;Author, { books: "reviews" }&gt;</code>-style adhoc typing of subgraphs, or at least this easily.</p>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>Other TypeScript ORMs (Prisma, Drizzle, Kysley, etc.) also leverage TypeScript's mapped types to create dynamic shapes of data, which is legitimately great.</p><p>However, they all have the fundamental approach of issuing "one-shot" queries that return immutable trees of POJOs, directly mapped from your SQL tables, and not subgraphs of entities that can have non-SQL abstractions &amp; be further incrementally loaded as/if needed (see <a href="https://joist-orm.io/docs/why-joist">Why Joist</a> for more on this).</p><p>You can generally see, for both issues covered so far (N+1s and statically-typed loaded-ness), most TypeScript ORMs have "solved" these issues by just removing the features all together, and restricting themselves to be "sophisticated query builders".</p><p>Joist's innovation is keeping the entity-based, incremental-loading mental model that is historically very popular/idiomatic for ORMs (particularly Ruby's ActiveRecord), and just fundamentally fixing it to not suck.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="joists-backend-reactivity">Joist's Backend Reactivity<a href="https://joist-orm.io/blog/the-best-orm-ever#joists-backend-reactivity" class="hash-link" aria-label="Direct link to Joist's Backend Reactivity" title="Direct link to Joist's Backend Reactivity">â€‹</a></h2>
<p>This 3rd section is the first feature that is unique to Joist itself: Joist's "backend reactivity".</p>
<p>Many ORMs have lifecycle hooks (this entity was created, updated, or deleted--which Joist <a href="https://joist-orm.io/docs/modeling/lifecycle-hooks">does as well</a>), to organize side effects/business logic of "when X changes, do Y".</p>
<p>But just lifecycle hooks by themselves can become tangled, complicated, and a well-known morass of complexity and "spooky action at a distance".</p>
<p>This is because they're basically "Web 1.0" imperative spaghetti code, where you have to manually instrument each mutation that might trigger a side effect.</p>
<p>(Concretely, lets say you have a rule that needs to look at both an author and its books. With raw lifecycle hooks, you must separately instrument both the "author update" and "book update" hooks to call your "make sure this author + books combination is still valid" logic. This can become tedious and error-prone, to get all the right hooks instrumented.)</p>
<p>Instead, Joist's <a href="https://joist-orm.io/docs/modeling/reactive-fields">reactive fields</a> and <a href="https://joist-orm.io/docs/modeling/validation-rules">reactive validation rules</a>  take the lessons of "declarative reactivity" from the Mobx/Solid/reactivity-aware frontend world, and bring it to the backend: reactive rules &amp; fields declare in one place what their "upstream dependencies" are, and Joist just handles wiring up the necessary cross-entity reactivity.</p>
<p>This brings a level of ease, specificity, and rigor to what are still effectively lifecycle hooks under the hood, that really makes them pleasant to work with.</p>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>The declarative nature of Joist's domain model-wide reactivity graph is also very amenable to DX tooling &amp; documentation generation, but we've not yet deeply explored/delivered any functionality that leverages it.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="conclusion-best-orm-ever">Conclusion: Best ORM Ever?<a href="https://joist-orm.io/blog/the-best-orm-ever#conclusion-best-orm-ever" class="hash-link" aria-label="Direct link to Conclusion: Best ORM Ever?" title="Direct link to Conclusion: Best ORM Ever?">â€‹</a></h2>
<p>So, these three features are what back up my exaggerated "best ORM ever" assertion.</p>
<p>If tomorrow, I suddenly could not use Joist, and had to find another ORM to use (or, in general, build any sort of application backend on top of a relational database), in any current/mainstream programming language, without a doubt I would want:</p>
<ol>
<li>Bullet-proof N+1 prevention,</li>
<li>Tracking loaded relation/subgraph state in the type system, and</li>
<li>Backend reactivity, for declarative cross-entity validation rules and reactive fields.</li>
</ol>
<p>And Joist is the only ORM that does all three of these: two of which are uniquely enabled by the JavaScript/TypeScript stack, and the third just part of Joist's own innovation.</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="disclaimer-1-uncomfortably-bold-claims">Disclaimer 1: Uncomfortably Bold Claims<a href="https://joist-orm.io/blog/the-best-orm-ever#disclaimer-1-uncomfortably-bold-claims" class="hash-link" aria-label="Direct link to Disclaimer 1: Uncomfortably Bold Claims" title="Direct link to Disclaimer 1: Uncomfortably Bold Claims">â€‹</a></h2>
<p>I usually don't like making bold/absolutist claims, like "this or that framework is 'the best'" or "technology x/y/z is terrible" or what not.</p>
<p>I did enough of that early in my career, and at this point I'm more interested in "what are the trade-offs?" and "what's the best tool for this specific use case?"</p>
<p>So, I hold two somewhat incongruent thoughts in my head, as I am both:</p>
<ul>
<li>Very confident that Joist is "the best" way to build application backends on top of a relational database, for a large majority of use cases/teams/codebases, but I also</li>
<li>Recognize it's "framework" / entity approach (see <a href="https://joist-orm.io/docs/why-joist">Why Joist</a>) might be either too opinionated or too much abstraction for some people's tastes, and just in general choices &amp; alternatives are always great to have.</li>
</ul>
<p>My guess is if you tried Joist, you would quickly come to like it, but it's also perfectly fine if not!</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="disclaimer-2-still-a-lot-to-do">Disclaimer 2: Still a Lot To Do<a href="https://joist-orm.io/blog/the-best-orm-ever#disclaimer-2-still-a-lot-to-do" class="hash-link" aria-label="Direct link to Disclaimer 2: Still a Lot To Do" title="Direct link to Disclaimer 2: Still a Lot To Do">â€‹</a></h2>
<p>Similar to the two incongruent thoughts above, another two semi-contradictory thoughts is the disclaimer that:</p>
<ul>
<li>Joist's core is very solid and vetted by 4+ years of production usage &amp; continual iteration at <a href="https://www.homebound.com/" target="_blank" rel="noopener noreferrer">Homebound</a>, but also</li>
<li>There's still a lot of work to do, obviously supporting other databases, but also the myriad fun, incremental improvement ideas we're tracking in the issue tracker, and of course even more that we've not thought of yet.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="feedback">Feedback<a href="https://joist-orm.io/blog/the-best-orm-ever#feedback" class="hash-link" aria-label="Direct link to Feedback" title="Direct link to Feedback">â€‹</a></h2>
<p>If you have thoughts, questions, or feedback, please let us know! Feel free to join the <a href="https://discord.gg/ky9VTQugqu" target="_blank" rel="noopener noreferrer">Joist discord</a>, or file issues on the GitHub repo if you try Joist and run into any issues.</p>
<p>Despite all the hubris in this post, we are still a very small project &amp; community, and so have a lot of growth and improvement ahead of us.</p>
<p>Thanks for the read!</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[New NextJS Sample App]]></title>
            <link>https://joist-orm.io/blog/nextjs-sample-app</link>
            <guid>https://joist-orm.io/blog/nextjs-sample-app</guid>
            <pubDate>Sun, 21 Apr 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[We've added a new NextJS sample app to the Joist repository.]]></description>
            <content:encoded><![CDATA[<p>We've added a new <a href="https://github.com/joist-orm/joist-nextjs-sample/" target="_blank" rel="noopener noreferrer">NextJS + Joist</a> sample app that shows how Joist can be used in a NextJS application, with several benefits:</p>
<ul>
<li>Automatic N+1 Prevention</li>
<li>JSON Payload/Props Creation</li>
<li>Optional Join-based Preloading</li>
</ul>
<p>This post gives a short overview; if you'd like to watch a video, we also have a <a href="https://youtu.be/H_qJdKUS9D0" target="_blank" rel="noopener noreferrer">YouTube video</a> that walks through the sample app.</p>
<div style="display:grid;place-items:center"><iframe width="750" height="420" src="https://www.youtube.com/embed/H_qJdKUS9D0?si=qUiRr0GTMrQCgayC" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin"></iframe></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="two-render-tree-approaches">Two Render Tree Approaches<a href="https://joist-orm.io/blog/nextjs-sample-app#two-render-tree-approaches" class="hash-link" aria-label="Direct link to Two Render Tree Approaches" title="Direct link to Two Render Tree Approaches">â€‹</a></h2>
<p>While building the sample app, we found two fundamental ways of structuring a NextJS app's render tree:</p>
<ol>
<li>Fewer React Server Components, that prop drill data to the Client Components<!-- -->
<ul>
<li>Shown on the left, see <code>author-rcc-card.tsx</code> and <code>book-rcc-preview.tsx</code></li>
</ul>
</li>
<li>Mostly React Server Components, with Client Components only at the bottom<!-- -->
<ul>
<li>Shown on the right, see <code>author-rsc-card.tsx</code> and <code>book-rsc-preview.tsx</code></li>
</ul>
</li>
</ol>
<div style="padding:24px"><img src="https://joist-orm.io/images/nextjs-sample-single-multiple-rscs.png"></div>
<p>The top-level <code>Table</code> / <code>table.tsx</code> component renders each of these side-by-side, so we can see the differences, and observe some pros/cons of each approach.</p>
<ul>
<li>
<p>With mostly RSC components, it's easy to decompose data loading away from the top-level component.</p>
<p>For example, the <code>AuthorRscCard</code> can make its own data loading calls, and even if it's render many pages on the page, Joist will de-dupe across the <code>N</code> sibling <code>AuthorRscCard</code>s, and batch into a single SQL call.</p>
<div class="language-tsx codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-tsx codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">AuthorCardProps</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** RSCs can accept the domain model enities as a prop. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  author</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Author</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">addBook</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/** The RSC version of AuthorCard can load it's own data. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AuthorRscCard</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addBook </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">AuthorCardProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// This will be auto-batched if many cards render at once</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> books </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> author</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">books</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Or if you wanted a tree of data, this will also be auto-batched</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> loaded </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> author</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">populate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> books</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> reviews</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ratings"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">...jsx</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is nice because it allows the <code>AuthorRscCard</code> to be more self-sufficient, and allow the parent table component to be unaware of its children loading details.</p>
</li>
<li>
<p>With mostly Client components, the opposite happens, and only the parent can make database / <code>EntityManager</code> calls, and so is responsible for loading all the data for its children, and passing it as JSON via props:</p>
<div class="language-tsx codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-tsx codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">AuthorCardProps</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** RCCs must accept a POJO of `Author` + all nested data. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  author</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">AuthorPayload</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">addBook</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/** The RCC version of AuthorCard accepts the `AuthorPayload`. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AuthorRccCard</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addBook </span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">AuthorCardProps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// can only use data already available on `author` </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Even though the up-front data load can become awkward, it does give more opportunities for optimizations; for example Joist can use join-based preloading to load a single tree of <code>Author</code> + <code>Book</code> + <code>Review</code> entities in a single SQL call, which is even better optimization than the "one query per layer" N+1 prevention of the RSC-based approach.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="automatic-n1-prevention">Automatic N+1 Prevention<a href="https://joist-orm.io/blog/nextjs-sample-app#automatic-n1-prevention" class="hash-link" aria-label="Direct link to Automatic N+1 Prevention" title="Direct link to Automatic N+1 Prevention">â€‹</a></h2>
<p>In either approach, Joist's N+1 prevention auto-batches database calls, even if they are made across separate component renders. I.e. in the RSC components:</p>
<ul>
<li>The top-level <code>Table</code> component makes 1 SQL call for all <code>Author</code> entities.</li>
<li>All 2nd-level <code>AuthorRscCard</code> cards each make their own <code>author.books.load()</code> (or <code>author.populate(...)</code>) call, but because they're all rendered in the same event loop, Joist batches all the <code>load</code> calls into 1 SQL call</li>
<li>Any 3rd-level components would have their <code>load</code> calls batched as well.</li>
</ul>
<p>In the React Client Component approach, this auto-batching is admittedly not as necessary, assuming a singular top-level component, like <code>Table</code>, loads all the data at once anyway (although, as mentioned later, Joist can optimize that as well).</p>
<p>See the <a href="https://joist-orm.io/docs/goals/avoiding-n-plus-1s">Avoiding N+1s</a> section of our docs for more information.</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="json-payloadprops-creation">JSON Payload/Props Creation<a href="https://joist-orm.io/blog/nextjs-sample-app#json-payloadprops-creation" class="hash-link" aria-label="Direct link to JSON Payload/Props Creation" title="Direct link to JSON Payload/Props Creation">â€‹</a></h2>
<p>Since the client components cannot make their own async data calls, the top-level <code>Table</code> components is responsible for loading all the data into a JSON payload, and passing it down to the children as props.</p>
<p>Joist entities have an easy way of doing this is, via a <code>toJSON</code> method that takes the shape of data to create:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Define the shape of data to create</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> authorHint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  firstName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  books</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    title</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reviews</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"id"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"rating"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">customField</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> satisfies JsonHint</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Author</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// This typedef can be used in the client-side props, or to match any</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// endpoint-based respones types like for REST/OpenAPI.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">AuthorPayload</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JsonPayload</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> authorHint</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toJSON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">authorHint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>toJSON</code> implementation will:</p>
<ul>
<li>Load any relations that are not yet loaded from the database</li>
<li>Output only the keys that are requested in the <code>authorHint</code></li>
<li>Call any lambdas like <code>customField</code> to generate custom values</li>
</ul>
<p>As with previous examples, all data loading is N+1 safe, and also potentially join-based preloaded.</p>
<p>See the <a href="https://joist-orm.io/docs/advanced/json-payloads">toJSON</a> docs for more information.</p>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>This recursive <code>toJSON</code> payload generation is a relatively new feature of Joist, so if you have feature ideas that would make it more useful, please let us know!</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="join-based-preloading">Join-Based Preloading<a href="https://joist-orm.io/blog/nextjs-sample-app#join-based-preloading" class="hash-link" aria-label="Direct link to Join-Based Preloading" title="Direct link to Join-Based Preloading">â€‹</a></h2>
<p>The last optimization that Joist can do is join-based preloading, which can be used in either the RSC or RCC approach.</p>
<p>This is also a newer feature that requires opt-ing in to, but in <code>em.ts</code> you can add a <code>preloadPlugin</code>:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/** Returns this request's `EntityManager` instance. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> getEm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cache</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Opt-in to preloading</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> preloadPlugin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">JsonAggregatePreloader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">EntityManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preloadPlugin </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will allow Joist to load a deep tree/subgraph of entities in a single SQL call.</p>
<p>For example, normally a Joist <code>em.find</code> a call like:</p>
<div class="language-ts codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-ts codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> em</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Author</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">populate</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> books</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"reviews"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Now access all the data in memory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">books</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reviews</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rating</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Will issue three SQL calls:</p>
<div class="language-sql codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-sql codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> authors </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> books </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> author_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> reviews </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> book_id </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>But with the <code>preloadPlugin</code> enabled, it will use a single SQL call that uses <code>CROSS JOIN LATERAL</code> and <code>json_agg</code> to return the author's books, and the book's reviews (omitted for brevity) in a single row:</p>
<div class="language-sql codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-sql codeBlock_RMoD thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_ </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> _b </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> authors </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">cross</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> lateral</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- create a tuple for each book, and aggregate then into an array of books</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> json_agg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json_build_array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">foreword</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">author_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">order</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> _</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> books _b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> _b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">author_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> _b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ? </span><span class="token keyword" style="color:#00009f">limit</span><span class="token plain"> ?</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-info admonition_WCGJ alert alert--info"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_pbrs"><p>Joist's join-based preloading is still a beta feature, so if you run into any issues, please let us know!</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="what-about-complex-queries">What about Complex Queries?<a href="https://joist-orm.io/blog/nextjs-sample-app#what-about-complex-queries" class="hash-link" aria-label="Direct link to What about Complex Queries?" title="Direct link to What about Complex Queries?">â€‹</a></h2>
<p>So far, our queries have focused on loading "just entities", and then putting those on the wire (or rendering them to HTML).</p>
<p>This is because Joist's focus is on building robust domain models, and specifically helping solve the "write-side" of your application's business logic (running the correct <a href="https://joist-orm.io/docs/modeling/validation-rules">validation rules</a>, <a href="https://joist-orm.io/docs/modeling/lifecycle-hooks">lifecycle hooks</a>, <a href="https://joist-orm.io/docs/modeling/reactive-fields">reactive updates</a>), and less so on the "read-side" of complex queries (i.e. that using aggregates using <code>GROUP BY</code>, multiple nested subqueries/projections/etc.).</p>
<p>As such, Joist does not yet have a sophisticated query builder that can create arbitrary SQL queries, like Kysley or Drizzle.</p>
<p>Instead, Joist encourages an approach that uses its robust write-side features to create materialized columns in the database, such that the majority of your pages/responses really can be served by "super simple <code>SELECT</code> statements", instead of using complicated queries to calculate aggregates on-the-fly.</p>
<p>Although you can of course use both approaches, and just use a lower-level query builder where needed.</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="sample-app-feedback">Sample App Feedback<a href="https://joist-orm.io/blog/nextjs-sample-app#sample-app-feedback" class="hash-link" aria-label="Direct link to Sample App Feedback" title="Direct link to Sample App Feedback">â€‹</a></h2>
<p>Joist's roots come from the GraphQL world, so this sample app was our first foray into using it for a NextJS application. If we've missed any key features that would make it easier to use Joist in a NextJS app, please let us know!</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Welcome]]></title>
            <link>https://joist-orm.io/blog/welcome-blog</link>
            <guid>https://joist-orm.io/blog/welcome-blog</guid>
            <pubDate>Sat, 13 Apr 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[First post on the Joist blog.]]></description>
            <content:encoded><![CDATA[<p>Hello! This is just a "Hello World" post to show the Joist blog, using <a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer"><strong>Docusaurus</strong></a>, is working <!-- -->ðŸŽ‰<!-- -->.</p>]]></content:encoded>
        </item>
    </channel>
</rss>