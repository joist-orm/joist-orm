<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-modeling/relations" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.2.0">
<title data-rh="true">Relations | Joist</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://joist-orm.io/docs/modeling/relations"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="keywords" content="TypeScript, ORM, Reactivity, Domain Driven Design, Unit of Work, ActiveRecord"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Relations | Joist"><meta data-rh="true" name="description" content="Relations are relationships between entities in your domain model, for example an Author&#x27;s list of Books or an Author&#x27;s current Publisher."><meta data-rh="true" property="og:description" content="Relations are relationships between entities in your domain model, for example an Author&#x27;s list of Books or an Author&#x27;s current Publisher."><link data-rh="true" rel="canonical" href="https://joist-orm.io/docs/modeling/relations"><link data-rh="true" rel="alternate" href="https://joist-orm.io/docs/modeling/relations" hreflang="en"><link data-rh="true" rel="alternate" href="https://joist-orm.io/docs/modeling/relations" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.37bfbcff.css">
<script src="/assets/js/runtime~main.e0e95bc5.js" defer="defer"></script>
<script src="/assets/js/main.0992c96b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_oPtH" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Joist</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/getting-started">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/goals">Goals</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/modeling/fields">Domain Modeling</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/features/entity-manager">Features</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/testing/test-factories">Testing</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/faq">FAQ</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/joist-orm/joist-orm" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://www.youtube.com/@joist-orm" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://discord.gg/ky9VTQugqu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_ki11 colorModeToggle_Hewu"><button class="clean-btn toggleButton_MMFG toggleButtonDisabled_Uw7m" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_lgto"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_U96C"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_bzqh"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_MB5r"><div class="docsWrapper__sE8"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_iEvu" type="button"></button><div class="docRoot_DfVB"><aside class="theme-doc-sidebar-container docSidebarContainer_c7NB"><div class="sidebarViewport_KYo0"><div class="sidebar_CUen"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_jmj1"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/getting-started/tour">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/goals">Goals</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/modeling/fields">Domain Modeling</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/modeling/fields">Fields</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/modeling/relations">Relations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/modeling/validation-rules">Validation Rules</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/modeling/lifecycle-hooks">Lifecycle Hooks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/modeling/enum-tables">Enums</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/modeling/derived-fields">Derived Fields</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/modeling/jsonb-fields">JSONB Fields</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/features/entity-manager">Features</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/advanced/unit-of-work">Advanced Features</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">FAQ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/testing/test-factories">Testing</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_a9sJ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_Qr34"><div class="docItemContainer_tjFy"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_T5ub" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_sfvy"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Domain Modeling</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Relations</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_wXna theme-doc-toc-mobile tocMobile_Ojys"><button type="button" class="clean-btn tocCollapsibleButton_iI2p">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Relations</h1></header><p>Relations are relationships between entities in your domain model, for example an <code>Author</code>&#x27;s list of <code>Book</code>s or an <code>Author</code>&#x27;s current <code>Publisher</code>.</p>
<p>Joist&#x27;s <code>joist-codegen</code> step automatically discovers the relations from your database schema (based on foreign keys) and generates either <code>Reference</code>s (for relations that point to a single other entity) or <code>Collection</code>s (for relations that point to multiple other entities).</p>
<p>Two common themes for all of Joist&#x27;s relations are that:</p>
<ol>
<li>
<p>They are by default unloaded, and require <code>await author.book.load()</code> calls to load, <em>but</em> also all support preloading via populate hints, see <a href="/docs/goals/load-safe-relations">load safe relations</a> for more.</p>
</li>
<li>
<p>Joist always keeps &quot;both sides&quot; of relationships in sync, for example if you add a <code>Book</code> to an <code>Author</code>, that <code>Author</code>&#x27;s list of books will automatically include that <code>Book</code>.</p>
<p>This is a big quality-of-life win, as business logic (validation rules, rendering logic) will always see the latest state of relations, and not have to worry about running against now-stale data.</p>
</li>
</ol>
<h3 id="reading-relations">Reading Relations</h3>
<p>In other ORMs you may be used to checking for the existings of a relation by checking for it&#x27;s presence, e.g. <code>if (book.author) { ... }</code>. In Joist, all relations are always present, but may not be set to a value. To check if a relation is set use <code>isSet</code>, for example:</p>
<pre><code class="language-typescript">const b1 = await em.load(Book, &quot;b:1&quot;);

// Always returns truthy
if (b1.author) {
  ...
}

// Returns true if the author is set
if (b1.author.isSet) {
  ...
}
</code></pre>
<p>If you want to read the id of a relation without loading it, you can do so via the <code>id</code> field:</p>
<pre><code class="language-typescript">const b1 = await em.load(Book, &quot;b:1&quot;);

// The id of the author is available without loading the author
const authorId = b1.author.id;
</code></pre>
<h2 id="many-to-one-references">Many To One References</h2>
<p>Joist looks for &quot;outgoing&quot; (many-to-one) foreign keys like <code>books.author_id</code> pointing to <code>books.id</code> and automatically includes a <code>ManyToOneReference</code> in the <code>BookCodegen</code> file:</p>
<pre><code class="language-typescript">export abstract class BookCodegen {
  readonly author: ManyToOneReference&lt;Book, Author, never&gt; = hasOne(authorMeta, &quot;author&quot;, &quot;books&quot;);
}
</code></pre>
<p>Accessing the <code>author</code> field requires either calling <code>.load()</code> or a populate hint:</p>
<pre><code class="language-typescript">// Unloaded author field
const b1 = await em.load(Book, &quot;b:1&quot;);
const a1 = await b1.author.load();
console.log(a1.firstName);

// Preloaded author field
const b2 = await em.load(Book, &quot;b:2&quot;, &quot;author&quot;);
console.log(b2.author.get.firstName);
</code></pre>
<admonition type="info"><p>If <code>books.author_id</code> is <code>not null</code>, then the reference will be required, i.e. <code>someBook.author.get</code> will return <code>Author</code>, otherwise it will be optional, and <code>someBook.author.get</code> will return <code>Author | undefined</code>.</p></admonition>
<h2 id="one-to-many-collections">One To Many Collections</h2>
<p>Joist also looks for &quot;incoming&quot; (one-to-many) foreign keys like the opposite of <code>Author</code> being &quot;pointed at&quot; by the <code>books.author_id</code> column and automatically generates a <code>hasMany</code> collection as the &quot;other side&quot; in <code>AuthorCodegen.ts</code>:</p>
<pre><code class="language-typescript">export abstract class AuthorCodegen {
  readonly books: Collection&lt;Author, Book&gt; = hasMany(bookMeta, &quot;books&quot;, &quot;author&quot;, &quot;author_id&quot;);
}
</code></pre>
<p>When unloaded, <code>Collection</code>s support adding and removing:</p>
<pre><code class="language-typescript">const a = await em.load(Author, &quot;a:1&quot;);
a.books.add(someBook);
a.books.remove(otherBook);
</code></pre>
<p>But accessing the contents of the collection requires being loaded, again either with a <code>.load()</code> call or a populate hint:</p>
<pre><code class="language-typescript">// Unloaded Author.books collection
const a1 = await em.load(Author, &quot;a:1&quot;);
const books = await a1.books.load();
console.log(books.length);

// Preloaded Author.books collection
const a2 = await em.load(Author, &quot;a:2&quot;, &quot;books&quot;);
console.log(a2.books.get.length);
console.log(a2.books.get[0].title);
</code></pre>
<h2 id="one-to-one-reference">One To One Reference</h2>
<p>Joist distinguishes &quot;incoming&quot; foreign keys with a unique constraint as a one-to-one relationship rather than one-to-many and instead automatically generates a <code>hasOneToOne</code> reference as the &quot;other side&quot; rather than <code>hasMany</code>:</p>
<pre><code class="language-typescript">export abstract class AuthorCodegen {
  readonly image: OneToOneReference&lt;Author, Image&gt; = hasOne(imageMeta, &quot;image&quot;, &quot;author&quot;, &quot;author_id&quot;);
}
</code></pre>
<p>These references work similarly to a <code>hasOne</code> reference, but have less information available to them when in an unloaded state (such as checking if the reference is set without loading it).  Additionally, they are always assumed to be nullable.</p>
<h2 id="many-to-many-collection">Many to Many Collection</h2>
<p>Joist will skip generating full entity classes for any tables it considers to be a &quot;join table&quot; between two other entities. Instead, it will  generate matching <code>hasManyToMany</code> collections on each of the entities pointed to by the foreign keys on the join table:</p>
<pre><code class="language-typescript">export abstract class BookCodegen {
  readonly tags: Collection&lt;Author, Tag&gt; = hasManyToMany(&quot;authors_to_tags&quot;, &quot;tags&quot;, &quot;author_id&quot;, tagMeta, &quot;authors&quot;, &quot;tag_id&quot;);
}
</code></pre>
<p>These collections work similarly to a <code>hasMany</code> collection. When determining if a table is a &quot;join table&quot;, joist checks if the table has a single primary key column, two foreign key columns, an optional <code>created_at</code> column, and no other columns. Joist also requires that the foreign keys are both <code>not null</code> and that the table has a unique constraint on the pair of foreign keys.</p>
<h2 id="polymorphic-references">Polymorphic References</h2>
<p>Polymorphic references model an entity (i.e. <code>Book</code>) that has a single logical field that can be set to multiple (i.e. poly) <em>types</em> of other entities, but <em>only one such entity at a time</em> (i.e. a reference b/c it points to only one other entity).</p>
<p>For example maybe a <code>Book</code> has a single logical <code>publisher</code> field that can either be a <code>CorporatePublisher</code> entity (a row in the <code>corporate_publishers</code> table) or a <code>SelfPublisher</code> entity (a row in the <code>self_publishers</code> table).</p>
<p>The simplest way to model this <code>Book</code> scenario would be having two foreign keys, a <code>books.corporate_publisher_id</code> and <code>books.self_publisher_id</code>, and then having your application&#x27;s business logic &quot;just know&quot; that it should enforce only one of these keys being set at a single time.</p>
<p>Polymorphic references allow you to tell Joist about this &quot;single logical field that could be two-or-more different types&quot;, and it will do the &quot;can only be set at once&quot; handling for you.</p>
<h3 id="implementation">Implementation</h3>
<p>Polymorphic references have two components:</p>
<ul>
<li>
<p>In the domain model, they are a single logical field (i.e. <code>Book.publisher</code>).</p>
<p>The field type is <code>PolymorphicReference&lt;BookPublisher&gt;</code>, where <code>BookPublisher</code> is a code generated type union of each potential type, i.e. Joist will create:</p>
<pre><code class="language-typescript"> export type BookPublisher = CorporatePublisher | SelfPublisher;
</code></pre>
<p>In the <code>BookCodegen.ts</code> file.</p>
</li>
<li>
<p>In the database schema, they are multiple physical columns, one per &quot;other&quot; entity type (i.e. <code>books.publisher_corporate_publisher_id</code> and <code>books.publisher_self_publisher_id</code>)</p>
</li>
</ul>
<h3 id="usage">Usage</h3>
<p>To use polymorphic references, there are two steps:</p>
<ol>
<li>
<p>Create the multiple physical foreign keys in your schema, all with a similar <code>publisher_*_id</code> naming convention.</p>
</li>
<li>
<p>In <code>joist-config.json</code>, add a new <code>publisher</code> relation that is marked as <code>polymorphic</code>:</p>
<pre><code class="language-json">{
  &quot;entites&quot;: {
     &quot;Comment&quot;: {
        &quot;relations&quot;: { &quot;publisher&quot;: { &quot;polymorphic&quot;: &quot;notNull&quot; } },
        &quot;tag&quot;: &quot;comment&quot;
     }
  }
}
</code></pre>
<p>Joist with then use the <code>publisher</code> name to scan for any other <code>publisher_</code>-prefixed foreign keys and automatically pull them in as components of this polymorphic reference.</p>
</li>
</ol>
<h2 id="renaming-relations">Renaming Relations</h2>
<p>Joist makes a best guess for relation names, based on the foreign key&#x27;s column name and the table it points to (i.e. the &quot;other side&quot; of <code>books.author_id</code> should be called <code>Author.books</code>), but this is not always perfect.</p>
<p>Sometimes a table will have two incoming foreign keys that cause a naming collision, or you just want a different name (self-referential foreign keys like <code>authors.mentor_id</code> are particularly hard for Joist to guess good names for).</p>
<p>In these circumstances, you can specify which field names to use directly in the database schema. Joist uses <code>pg-structure</code>&#x27;s <a href="https://www.pg-structure.com/nav.02.api/classes/dbobject.html#commentdata"><code>commentData</code></a> convention (which is basically a JSON payload in the column&#x27;s <code>COMMENT</code> metadata) to look for two properties:</p>
<ul>
<li><code>fieldName</code> for renaming a m2o reference, and</li>
<li><code>otherFieldName</code> for renaming the opposing m2o/m2m/o2o relation</li>
</ul>
<p>Setting this <code>commentData</code> structure by hand can be tedious, but Joist&#x27;s <code>joist-migration-utils</code> package provides both a <code>renameRelation</code> function (for renaming fields of existing columns) and a <code>foreignKey</code> helper (for renames fields on new columns) that allow easily setting the <code>fieldName</code> and <code>otherFieldName</code> keys.</p>
<admonition type="info"><p>Why <code>COMMENT</code> metadata? Putting field names in the <code>COMMENT</code> metadata is somewhat unconventional, but it has a few advantages:</p><ol>
<li>
<p>It follows Joist&#x27;s overall philosophy of &quot;the database is the source of truth&quot;, and</p>
</li>
<li>
<p>Previously we put renames in the <code>joist-config.json</code> file, but that meant having to know/guess the wrong/unintuitive name, just to map it over to the correct name. Which was confusing and also did not handle collisions.</p>
</li>
</ol><p>With the <code>COMMENT</code> approach, the <code>joist-config.json</code> now has only the correct/best field name for the rest of the config options you might want to specify on the relation.</p></admonition>
<h2 id="consistent-relations">Consistent Relations</h2>
<p>Joist keeps both sides of m2o/o2m/o2o relationships in sync, i.e.:</p>
<pre><code class="language-typescript">// Load the author with the books collection loaded
const a = await em.load(Author, &quot;a:1&quot;, &quot;books&quot;);
// Load a book, and set the author
const b = await em.load(Book, &quot;b:1&quot;);
b.author.set(a);
// This will print true
console.log(a.books.get.includes(b));
</code></pre>
<p>If the <code>Author.books</code> collection is not loaded yet, then the <code>b.author.set</code> line does not cause it to become loaded, but instead will remember &quot;add <code>b</code>&quot; as a pending operation, to apply to <code>a.books</code>, should it later become loaded within the current <code>EntityManager</code>.</p>
<h2 id="custom-relations">Custom Relations</h2>
<p>Besides the core relations discovered from the schema&#x27;s foreign keys, Joist lets you declare additional relations in your domain model.</p>
<admonition type="tip"><p>These custom relations are great for defining relationships between <em>entities</em> in your domain model, like how <code>Author</code> might relate to <code>BookReview</code>.</p><p>If you&#x27;d like to define custom <em>non-entity</em> fields, like derived numbers or strings, see <a href="./derived-fields">Derived Fields</a>.</p></admonition>
<h3 id="hasonethrough">hasOneThrough</h3>
<p><code>hasOneThrough</code> defines a shortcut from your entity to a single other entity, for example if asking for a <code>BookReview</code>&#x27;s author (via the <code>Book</code>) is very common, you can define a <code>BookReview.author</code> relation:</p>
<pre><code class="language-typescript">export class BookReview extends BookReviewCodegen {
  // use never if Author will always be set, or undefined if it might be unset
  readonly author: Reference&lt;BookReview, Author, never&gt; = hasOneThrough((review) =&gt; review.book.author);
  // Paths can be arbitrarily long
  readonly publisher: Reference&lt;BookReview, Publisher, never&gt; = hasOneThrough((review) =&gt; review.book.author.publisher);
}
</code></pre>
<p>With this alias defined, you can refactor code to be more succinct:</p>
<pre><code class="language-typescript">// Using the core relations
const br1 = await em.load(BookReview, { book: { author: &quot;publisher&quot; } });
console.log(`br1 publisher:` + br1.book.get.author.get.publisher.get);

// Using the hasOneThrough alias
const br2 = await em.load(BookReview, &quot;publisher&quot;);
console.log(`br2 publisher:` + br2.publisher.get);
</code></pre>
<p>Both of these approaches have the same runtime behavior, i.e. under the hook <code>br2.publisher.get</code> is actually executing <code>review.book.get.author.get.publisher.get</code>.</p>
<admonition type="info"><p>Note that currently <code>hasOneThrough</code> and <code>hasManyThrough</code> load all the entities on the path between the current entity and the target(s), i.e. the above example pulls all the review&#x27;s books, the book&#x27;s authors, and the author&#x27;s publisher into memory.</p><p>We have an issue tracking optimizing this to avoid loading entities, see <a href="https://github.com/joist-orm/joist-orm/issues/524">Issue 524</a>.</p></admonition>
<h3 id="hasmanythrough">hasManyThrough</h3>
<p><code>hasManyThrough</code> is very similar to <code>hasOneThrough</code> but for collections of multiple entities:</p>
<pre><code class="language-typescript">export class Publisher extends PublisherCodegen {
  readonly reviews: Collection&lt;Publisher, BookReview&gt; = hasManyThrough((p) =&gt; p.authors.books.bookReviews);
}
</code></pre>
<p>The behavior is the same as <code>hasOneThrough</code>:</p>
<pre><code class="language-typescript">// Using the core relations
const p1 = await em.load(Publisher, { authors: { books: &quot;reviews&quot; } });
console.log(`p1 reviews:` + p1.authors.get.flatMap(a =&gt; a.books.get.flatMap(b =&gt; b.reviews.get)));

// Using the hasManyThrough alias
const p2 = await em.load(Publisher, &quot;reviews&quot;);
console.log(`p2 reviews:` + p2.reviews.get);
</code></pre>
<h3 id="hasonederived--hasmanyderived">hasOneDerived &amp; hasManyDerived</h3>
<p><code>hasOneDerived</code> and <code>hasManyDerived</code> are very similar to <code>hasOneThrough</code> and <code>hasManyThrough</code>, but allow a lambda to filter the results.</p>
<p>For example, maybe <code>Publisher.reviews</code> should only be <code>public</code> reviews:</p>
<pre><code class="language-typescript">class BookReview extends PublisherCodegen {
  readonly reviews: Collection&lt;Publisher, BookReview&gt; = hasManyDerived(
    { authors: { books: &quot;reviews&quot; } },
    (p) =&gt; p.authors.get
      .flatMap(a =&gt; a.books.get.flatMap(b =&gt; b.reviews.get))
      .filter(br =&gt; br.isPublic)
  );
}
</code></pre></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/joist-orm/joist-orm/edit/main/docs/docs/modeling/relations.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_bHB7" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_ydrU"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/modeling/fields"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Fields</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/modeling/validation-rules"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Validation Rules</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_XG6w thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#reading-relations" class="table-of-contents__link toc-highlight">Reading Relations</a></li><li><a href="#many-to-one-references" class="table-of-contents__link toc-highlight">Many To One References</a></li><li><a href="#one-to-many-collections" class="table-of-contents__link toc-highlight">One To Many Collections</a></li><li><a href="#one-to-one-reference" class="table-of-contents__link toc-highlight">One To One Reference</a></li><li><a href="#many-to-many-collection" class="table-of-contents__link toc-highlight">Many to Many Collection</a></li><li><a href="#polymorphic-references" class="table-of-contents__link toc-highlight">Polymorphic References</a><ul><li><a href="#implementation" class="table-of-contents__link toc-highlight">Implementation</a></li><li><a href="#usage" class="table-of-contents__link toc-highlight">Usage</a></li></ul></li><li><a href="#renaming-relations" class="table-of-contents__link toc-highlight">Renaming Relations</a></li><li><a href="#consistent-relations" class="table-of-contents__link toc-highlight">Consistent Relations</a></li><li><a href="#custom-relations" class="table-of-contents__link toc-highlight">Custom Relations</a><ul><li><a href="#hasonethrough" class="table-of-contents__link toc-highlight">hasOneThrough</a></li><li><a href="#hasmanythrough" class="table-of-contents__link toc-highlight">hasManyThrough</a></li><li><a href="#hasonederived--hasmanyderived" class="table-of-contents__link toc-highlight">hasOneDerived &amp; hasManyDerived</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/goals">Goals</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/joist-orm/joist-orm/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/ky9VTQugqu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2024</div></div></div></footer></div>
</body>
</html>