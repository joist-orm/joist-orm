<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-testing/test-factories" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.2.0">
<title data-rh="true">Test Factories | Joist</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://joist-orm.io/docs/testing/test-factories"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="keywords" content="TypeScript, ORM, Reactivity, Domain Driven Design, Unit of Work, ActiveRecord"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Test Factories | Joist"><meta data-rh="true" name="description" content="Joist generates customizable factories for easily creating test data, i.e. a test can easily create any entity, with all its required fields &amp; dependencies transitively filled in, with a single line:"><meta data-rh="true" property="og:description" content="Joist generates customizable factories for easily creating test data, i.e. a test can easily create any entity, with all its required fields &amp; dependencies transitively filled in, with a single line:"><link data-rh="true" rel="canonical" href="https://joist-orm.io/docs/testing/test-factories"><link data-rh="true" rel="alternate" href="https://joist-orm.io/docs/testing/test-factories" hreflang="en"><link data-rh="true" rel="alternate" href="https://joist-orm.io/docs/testing/test-factories" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.37bfbcff.css">
<script src="/assets/js/runtime~main.e0e95bc5.js" defer="defer"></script>
<script src="/assets/js/main.0992c96b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_oPtH" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Joist</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/getting-started">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/goals">Goals</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/modeling/fields">Domain Modeling</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/features/entity-manager">Features</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/testing/test-factories">Testing</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/faq">FAQ</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/joist-orm/joist-orm" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://www.youtube.com/@joist-orm" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://discord.gg/ky9VTQugqu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_ki11 colorModeToggle_Hewu"><button class="clean-btn toggleButton_MMFG toggleButtonDisabled_Uw7m" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_lgto"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_U96C"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_bzqh"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_MB5r"><div class="docsWrapper__sE8"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_iEvu" type="button"></button><div class="docRoot_DfVB"><aside class="theme-doc-sidebar-container docSidebarContainer_c7NB"><div class="sidebarViewport_KYo0"><div class="sidebar_CUen"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_jmj1"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/getting-started/tour">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/goals">Goals</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/modeling/fields">Domain Modeling</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/features/entity-manager">Features</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/advanced/unit-of-work">Advanced Features</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">FAQ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/testing/test-factories">Testing</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/testing/test-factories">Test Factories</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/testing/fast-database-resets">Fast Database Resets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/testing/entity-matcher">Custom Jest Matcher</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/testing/test-utils">Test Utils</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_a9sJ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_Qr34"><div class="docItemContainer_tjFy"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_T5ub" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_sfvy"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Testing</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Test Factories</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_wXna theme-doc-toc-mobile tocMobile_Ojys"><button type="button" class="clean-btn tocCollapsibleButton_iI2p">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Test Factories</h1></header><p>Joist generates customizable factories for easily creating test data, i.e. a test can easily create any entity, with all its required fields &amp; dependencies transitively filled in, with a single line:</p>
<pre><code class="language-ts">// Given an author...
const a = newAuthor(em);
</code></pre>
<p>The approach is very similar to generic test factory tools like <a href="https://github.com/thoughtbot/fishery">Fishery</a>, but with deep/native integration with Joist.</p>
<p>The goal of test factories are to provide tests (and only tests!) with &quot;valid by default&quot; instances of entities, so that each test can focus solely on the state/behavior that is unique to its boundary case.</p>
<p>Joist also fundamentally assumes the database is reset between each test (see <a href="/docs/testing/fast-database-resets">Fast Database Resets</a>), and so allowing tests to succinctly create the entire graph of entities they need is a key part of Joist&#x27;s developer experience.</p>
<admonition type="tip"><p>Note that Joist&#x27;s factories are <strong>not intended to be used in production code</strong>; they are only for quickly creating synthetic data in unit tests.</p></admonition>
<h2 id="overview">Overview</h2>
<p>For example, given a <code>Book</code> entity, Joist creates an initial <code>newBook.ts</code> file that looks like:</p>
<pre><code class="language-typescript">import { EntityManager, FactoryOpts, New, newTestInstance } from &quot;joist-orm&quot;;
import { Book } from &quot;../entities&quot;;

export function newBook(em: EntityManager, opts: FactoryOpts&lt;Book&gt; = {}): New&lt;Book&gt; {
  return newTestInstance(em, Book, opts, {});
}
</code></pre>
<p>Tests can then call <code>newBook</code> with as few opts as they want, and all required fields (for both primitives and relations) will be filled in.</p>
<p>For example, since <code>book.author_id</code> is a not-null column, calling <code>const b1 = newBook()</code> will create both a <code>Book</code> with a <code>title</code> (required primitive field) as well as create a new <code>Author</code> (required foreign key/many-to-one field) and assign it to <code>b1.author</code>:</p>
<pre><code class="language-typescript">const b = newBook(em);
expect(b.title).toEqual(&quot;title&quot;);
expect(b.author.get.firstName).toEqual(&quot;firstName&quot;);
</code></pre>
<p>This creation is recursive, i.e. <code>newBookReview()</code> will make a new <code>BookReview</code>, a new <code>Book</code> (required for <code>bookReview.book</code>), and a new <code>Author</code> (required for <code>book.author</code>).</p>
<p>Importantly, you can also pass partials for either the book or the author:</p>
<pre><code class="language-typescript">// Given a book by the author &quot;a1&quot;
const b = newBook(em, { author: { firstName: &quot;a1&quot; } });
// Then we got the default title
expect(b.title).toEqual(&quot;title&quot;);
// And &quot;a1&quot; was used as the author&#x27;s firstName
expect(b.author.get.firstName).toEqual(&quot;a1&quot;);
</code></pre>
<p>This is key so that your tests can <strong>set only the minimum amount of fields necessary to specify their boundary case</strong>, and defer to the factories for any other irrelevant boilerplate.</p>
<h2 id="usage">Usage</h2>
<h3 id="defaults-for-primitives">Defaults for Primitives</h3>
<p>Factories can provide test suite-wide defaults, for example providing a default age:</p>
<pre><code class="language-typescript">// Default Authors (only within tests) to age 40
export function newAuthor(
  em: EntityManager,
  opts: FactoryOpts&lt;Author&gt; = {},
): DeepNew&lt;Author&gt; {
  return newTestInstance(em, Author, opts, {
    age: 40,
  });
}
</code></pre>
<p>And then every <code>newAuthor</code> will have an <code>age</code> of 40, unless a test specifically requires a different age:</p>
<pre><code class="language-typescript">// Given an author that is 30
const a = newAuthor(em, { age: 30 });
// Then we didn&#x27;t use the default age
expect(a.age).toEqual(30);
</code></pre>
<admonition type="tip"><p>This can be particularly helpful when you&#x27;re adding a new field to an existing entity, and want all tests to have a default value for the new field, without updating every individual test.</p></admonition>
<h3 id="unique-strings">Unique Strings</h3>
<p>If you have a field that must be unique, like <code>name</code> with a database-enforce <code>UNIQUE</code> constraint, you can use the <code>testIndex</code> helper to automatically create unique-but-deterministic values:</p>
<pre><code class="language-typescript">import { testIndex } from &quot;joist-orm&quot;;

export function newBook(em: EntityManager, opts: FactoryOpts&lt;Book&gt; = {}): New&lt;Book&gt; {
  return newTestInstance(em, Book, opts, {
    // Make a unique name, `testIndex` will be 1/2/etc increasing and reset per-test
    title: `b${testIndex}`,
  });
}
</code></pre>
<h3 id="defaults-for-references">Defaults for References</h3>
<p>Factories can also provide default entities, for example a book creating a default author:</p>
<pre><code class="language-typescript">export function newBook(em: EntityManager, opts: FactoryOpts&lt;Book&gt; = {}): New&lt;Book&gt; {
  return newTestInstance(em, Book, opts, {
    author: {},
  });
}
</code></pre>
<p>Note that, if <code>author</code> was required, we would not have to explicitly pass <code>author: {}</code>; we&#x27;d only pass <code>author</code> to <code>newTestInstance</code> if:</p>
<ul>
<li>The <code>author</code> field is not required, but we want all test <code>Book</code>s to have one anyway</li>
<li>We want all <code>Book</code>s&#x27; authors to themselves have some specific defaults, like <code>author: { age: 30 }</code>,</li>
<li>We want to explicitly create a <em>new</em> author (see the next point)</li>
</ul>
<h3 id="reusing-existing-entities">Reusing Existing Entities</h3>
<p>When factories need to set a relation field, they will first look for an &quot;obvious default&quot; entity before creating a new entity.</p>
<p>This is useful for stitching together complex schemas, because it means validation rules like &quot;a <code>BookReview</code> must have the same <code>bookReview.author</code> as its <code>bookReview.author.book</code>&quot; (pretending that <code>BookReview</code> had its own <code>author</code> field) will pass &quot;for free&quot; because we don&#x27;t &quot;sprawl out&quot; and continually create new/unnecessary entities.</p>
<p>That said, Joist will only reuse an entity if there is a <em>single</em> instance of that entity.</p>
<pre><code class="language-typescript">// Given we have a single author
const a = newAuthor(em);
// Then newBook will see &quot;there is only 1 author&quot; and assume we want that one
const b = newBook(em);
expect(b.author.get).toEqual(a);
</code></pre>
<p>If there are multiple <code>Author</code>s created in the test, Joist sees it as ambiguous which one it should use, and so creates a new <code>Author</code>:</p>
<pre><code class="language-typescript">// Given we have two existing Authors
const [a1, a2] = [newAuthor(em), newAuthor(em)];
// Then newBook will create a 3rd Author
const b = newBook(em);
expect(b.author.get.name).toEqual(&quot;a3&quot;);
</code></pre>
<h4 id="forcing-new-entities">Forcing New Entities</h4>
<p>If you want to a specific field to never reuse existing entities, you can use <code>{}</code> as a marker for &quot;always create a new entity&quot;:</p>
<pre><code class="language-typescript">export function newBook(em: EntityManager, opts: FactoryOpts&lt;Book&gt; = {}): New&lt;Book&gt; {
  return newTestInstance(em, Book, opts, {
    author: {},
  });
}
</code></pre>
<h4 id="reusing-entities-with-use">Reusing Entities With <code>use</code></h4>
<p>As covered, if your test has already created multiple entities of a given type (e.g. multiple <code>Author</code>s), Joist will not use them as &quot;obvious defaults&quot;, but if you want to nominate a specific <code>Author</code> as the default for a given <code>newBookReview</code> call, you can pass the <code>use</code> option:</p>
<pre><code class="language-typescript">// We have multiple authors
const [a1, a2] = [newAuthor(em), newAuthor(em)];
// Make a new book review, but use a2 instead of creating a new Author
const br = newBookReview(em, { use: a2 });
</code></pre>
<h3 id="defaults-for-collections">Defaults for Collections</h3>
<p>If you have validation rules like &quot;all <code>Author</code>s must have at least one <code>Book</code>&quot;, the <code>newAuthor</code> factory can create valid-by-default <code>Author</code>s by passing <code>books: [{}]</code>:</p>
<pre><code class="language-typescript">export function newAuthor(em: EntityManager, opts: FactoryOpts&lt;Author&gt; = {}): DeepNew&lt;Author&gt; {
  return newTestInstance(em, Author, opts, {
    // Every Author has at least one Book
    books: [{}],
  });
}
</code></pre>
<p>Note that, due to the native factory integration, Joist is smart enough that if you create the graph &quot;bottom up&quot; and call <code>newBook()</code>, it will be smart enough to know that <code>newAuthor</code> should not create a 2nd book:</p>
<pre><code class="language-typescript">// Given we create a book
const b = newBook(em);
// Then `newAuthor` was effectively passed `books: [b]` and did not create a 2nd book
expect(b.author.get.books.get.length).toBe(1);
</code></pre>
<h3 id="custom-opts">Custom Opts</h3>
<p>Besides just setting existing entity fields, like <code>Author.firstName</code> and <code>Books.author</code>, Joist&#x27;s factories allow you to declare custom, factory-specific opts so that multiple tests can request the similar &quot;pre-baked&quot; test data from a factory.</p>
<admonition type="info"><p>In fishery, these are called transient params.</p></admonition>
<p>For example, a test might need to create a somewhat large graph of test data for a business scenario, perhaps a <code>Book</code> with a signed contract with a larger publisher (this is not that big, but it&#x27;s a good example):</p>
<pre><code class="language-typescript">// Given a book that is signed with a large publisher
const b = newBook(em, {
  author: {
    contracts: [{ signed: true, publisher: { type: &quot;large&quot; } }],
  },
});
</code></pre>
<p>If this &quot;create a book ... with an author ... with a contract ... that is signed&quot; is a common requirement for tests, it can be cumbersome to copy/paste this snippet across many tests, and keep it up to date (perhaps <code>signed</code> changes from <code>true</code> to a <code>signedOn</code> timestamp).</p>
<p>Instead, Joist&#x27;s factories allow you to add a custom <code>withSignedContract</code> opt to the <code>newBook</code> factory:</p>
<pre><code class="language-typescript">// Add an optional `withSignedContract` opt
export function newBook(
  em: EntityManager,
  opts: FactoryOpts&lt;Book&gt; &amp; { withSignedContract?: boolean } = {},
): New&lt;Book&gt; {
  return newTestInstance(em, Book, opts, {
    // Conditionally create the snippet when requested
    ...(opts.withSignedContract ? { author: { contracts: [{ signed: true, publisher: { type: &quot;large&quot; } }] } } : {}),
  });
}
</code></pre>
<p>And now tests can request this behavior for free:</p>
<pre><code class="language-typescript">// Given we have a book with a signed contract
const book = newBook(em, { title: &quot;b1&quot;, withSignedContract: true });
// And it also works if going through BookReview
const br = newBookReview(em, { book: { withSignedContract: true } });
</code></pre>
<p>In general, we have two recommendations for this feature:</p>
<ul>
<li>
<p>Be careful and don&#x27;t abuse it; tests are simplest to read when any assertions they have are against data that is specified directly inline in the &quot;Given&quot; block; if you&#x27;ve abstracted too much of your test&#x27;s setup to a custom opt, it will hurt readability.</p>
<p>Also, custom opts are a slippery slope to the seed data anti-pattern, where the seed data becomes so large &amp; gnarly (because it&#x27;s been tweaked over the years to support more and more disparate test cases), that the seed data becomes very brittle and can&#x27;t be changed without failing a ton of tests.</p>
</li>
<li>
<p>Use prefixes like <code>with</code> and <code>and</code> in the names of custom opts, e.g. <code>withSignedContract</code> or <code>andSigned</code> to make it clear to readers that the opt is custom to the factory and not actually a regular database/entity field.</p>
</li>
</ul>
<h3 id="disabling-factory-defaults">Disabling Factory Defaults</h3>
<p>Sometimes you&#x27;ll have a test that wants to opt-out of the defaults provided by a factory.</p>
<p>You can do this by using <code>useFactoryDefaults: false</code>, for example if <code>newAuthor.ts</code> establishes a default age of 40, you can ignore it by passing <code>useFactoryDefaults: false</code>:</p>
<pre><code class="language-typescript">// Ignore the default when creating an author
const a = newAuthor(em, { useFactoryDefaults: false });

// You can also ignore when creating an author via another factory
const br = newBookReview(em, {
  book: { author: { useFactoryDefaults: false } },
});
</code></pre>
<p>Setting <code>useFactoryDefaults: false</code> ignores the defaults inside of <code>newAuthor.ts</code>, <code>newBook.ts</code>, etc., but it does not disable Joist&#x27;s fundamental &quot;required fields must always be set&quot; defaults.</p>
<p>If you want to disable those as well, you can use <code>useFactoryDefaults: &quot;none&quot;</code>:</p>
<pre><code class="language-typescript">// Ignore all defaults
const b = newBook(em, { useFactoryDefaults: &quot;none&quot; });
// Normally this would be &quot;title&quot;, but is left unset
expect(b.title).toBeUndefined();
// Normally this would be a new/existing Author, but is left unset
expect(b.author.get).toBeUndefined();
</code></pre>
<admonition type="tip"><p>If you find yourself regularly using <code>useFactoryDefaults</code>, it might be an indication that your factory&#x27;s defaults are too opinionated, and the factory should do less by default.</p><p>For example, instead of the factory having &quot;not actually universally required/useful&quot; defaults that frequently need to be turned off, only the tests that actually rely on the sometimes-wanted/sometimes-not-wanted defaults should opt in to them via a dedicated custom opt.</p></admonition>
<h2 id="deepnew--async-free-assertions">DeepNew / <code>async</code> Free Assertions</h2>
<p>In production code, Joist relations must be accessed asynchronously, i.e. either with <code>load()</code> calls or <code>populate</code> preloads:</p>
<pre><code class="language-typescript">// Call load directly
const b1 = await em.load(Book, &quot;b:1&quot;);
const a1 = await book.author.load();
// Use a preload
const b2 = await em.load(Book, &quot;b:2&quot;, &quot;author&quot;);
const a2 = book.author.get;
</code></pre>
<p>However, because in tests we &quot;just know&quot; there is a) not that much data, and b) the factories control the instantiation of all entities, we can make the assumption that all relations are loaded already.</p>
<p>So factories return a special <code>DeepNew</code> type that marks all relations as loaded:</p>
<pre><code class="language-typescript">it(&quot;some test&quot;, async () =&gt; {
  const em = newEntityManager();
  // Given a book
  const b1 = newBook(em);
  // When we exercise our production code
  performSomeBusinessLogic(b1);
  // Then we can assert against b1.authors w/o an await/load
  expect(b1.authors.get.length).toBe(1);
  // And we can assert against the author&#x27;s publisher
  expect(b1.authors.get[0].publisher.get.name).toBe(&quot;p1&quot;);
});
</code></pre>
<p>This capability can dramatically clean up test assertions, by removing the need for <code>await</code> and <code>load()</code> calls.</p>
<admonition type="tip"><p>Also see Joist&#x27;s <a href="/docs/testing/entity-matcher">toMatchEntity</a>, which provides another ergonomic way to assert against entities.</p></admonition>
<h2 id="singletons-with-the-useexisting-option">Singletons with the <code>useExisting</code> option</h2>
<p>Sometimes when a test has just called <code>newAuthor</code>, we want the factory to realize that, due to unique constraints/business logic specific to <code>Author</code>, that the appropriate <code>Author</code> instance the test is asking for already exists.</p>
<p>An example is schemas with &quot;enum-like&quot; or &quot;singleton&quot; entities. Enum-like entities are user-added rows in the database (they are not a true <code>enum</code>), but still have enum-like behavior like &quot;there should be only one of these entities for the given (name, parent, etc.) set of values&quot;, potentially backed by database-level unique constrains.</p>
<p>An example might be a <code>PublisherType</code> entity that is effectively unique on a <code>name</code> column, where the desired behavior is:</p>
<pre><code class="language-ts">// Creates a new PublisherType w/name: large
newPublisher(em, { type: { name: &quot;large&quot; } });
// Creates a new PublisherType w/name: small
newPublisher(em, { type: { name: &quot;small&quot; } });
// Should reuse the existing PublisherType w/name: large
newPublisher(em, { type: { name: &quot;large&quot; } });
</code></pre>
<p>In these situations, you effectively want your factory to &quot;scan existing entities&quot; and look for an entity that matches the test&#x27;s requested opts.</p>
<p>To do this, you can use the <code>useExisting</code> flag on <code>newTestInstance</code>, which is a lambda that returns &quot;does the test&#x27;s requested opts match this existing <code>PublisherType</code>&quot;?:</p>
<pre><code class="language-ts">export function newPublisherType(
  em: EntityManager,
  opts: FactoryOpts&lt;PublisherType&gt; = {},
): DeepNew&lt;PublisherType&gt; {
  return newTestInstance(
    em,
    {},
    { useExisting: (opts, existing) =&gt; existing.name === opts.name },
  );
}
</code></pre>
<p>The benefit of using <code>useExisting</code> is that the <code>existing</code> param will already be typed to your given entity type (i.e. <code>PublisherType</code>), and the <code>opts</code> param will be the &quot;post-resolution&quot; opts, i.e. instead of &quot;maybe object literals or maybe object instances&quot;, they will be object instances (basically <code>OptsOf&lt;PublisherType&gt;</code>), which simplifies the lambda&#x27;s matching logic.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/joist-orm/joist-orm/edit/main/docs/docs/testing/test-factories.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_bHB7" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_ydrU"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/faq"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">FAQ</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/testing/fast-database-resets"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Fast Database Resets</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_XG6w thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#usage" class="table-of-contents__link toc-highlight">Usage</a><ul><li><a href="#defaults-for-primitives" class="table-of-contents__link toc-highlight">Defaults for Primitives</a></li><li><a href="#unique-strings" class="table-of-contents__link toc-highlight">Unique Strings</a></li><li><a href="#defaults-for-references" class="table-of-contents__link toc-highlight">Defaults for References</a></li><li><a href="#reusing-existing-entities" class="table-of-contents__link toc-highlight">Reusing Existing Entities</a></li><li><a href="#defaults-for-collections" class="table-of-contents__link toc-highlight">Defaults for Collections</a></li><li><a href="#custom-opts" class="table-of-contents__link toc-highlight">Custom Opts</a></li><li><a href="#disabling-factory-defaults" class="table-of-contents__link toc-highlight">Disabling Factory Defaults</a></li></ul></li><li><a href="#deepnew--async-free-assertions" class="table-of-contents__link toc-highlight">DeepNew / <code>async</code> Free Assertions</a></li><li><a href="#singletons-with-the-useexisting-option" class="table-of-contents__link toc-highlight">Singletons with the <code>useExisting</code> option</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/goals">Goals</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/joist-orm/joist-orm/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/ky9VTQugqu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPrP"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2024</div></div></div></footer></div>
</body>
</html>